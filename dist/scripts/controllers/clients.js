define(["controllers/controllers","config"],function(e,t){e.controller("clientCtrl",["$rootScope","$scope","$location","Report","Clients","Teams","data","$route","$routeParams","Store","Dater","$filter","$modal","TeamUp","$timeout","Reports",function(e,n,r,i,s,o,u,a,f,l,c,h,p,d,v,m){function k(e){angular.forEach(u.clientGroups,function(t){t.id==e&&(n.clientGroup=t)}),n.clients=u.clients[e],n.current=e,n.views.reports&&(n.currentCLient="0",n.currentMonth="0",C())}function O(){return n.getView(n.report),p({template:"views/reportTemplate.html",scope:n,animation:"am-fade"})}e.fixStyles(),e.resetPhoneNumberChecker();var g=null;if(u.clientId){var y=!1;m.clientId=u.clientId,u.clientGroups=l("app").get("ClientGroups"),u.clients={},angular.forEach(u.clientGroups,function(e){u.clients[e.id]=l("app").get(e.id),angular.forEach(u.clients[e.id],function(e){e.uuid==u.clientId&&(n.client=e,n.contacts=e.contacts,e.birthDate=moment(e.birthDate).format("DD-MM-YYYY"),n.clientmeta=e,y=!0)})}),y||(u.clients=l("app").get("clients"),u.client=_.findWhere(u.clients,{uuid:u.clientId}),m.clientId=n.client.uuid,n.client=u.client,n.contacts=u.client.contacts,u.client.birthDate=moment(client.birthDate).format("DD-MM-YYYY"),n.clientmeta=u.client)}n.imgHost=t.app.host,n.ns=t.app.namespace,n.clients=u.clients,n.clientGroups=u.clientGroups;var b=c.getMonthTimeStamps();n.Months=[],angular.forEach(b,function(e,t){n.Months[t]={number:t,name:t,start:e.first.timeStamp,end:e.last.timeStamp}}),n.Months[0]={number:0,name:e.ui.teamup.selectMonth};var w=r.search(),E=w.reportUuid;n.search={query:""},n.selection={},n.data=u;var S,x;!w.uuid&&!r.hash()?(S=u.clientGroups[0].id,x="client",r.search({uuid:u.clientGroups[0].id}).hash("client")):w.uuid?(S=w.uuid,typeof S=="undefined"&&(S=n.client.clientGroupUuid),x=r.hash()):(S=u.clientGroups[0].id,x=r.hash(),r.search({uuid:S})),n.views={client:!0,newClientGroup:!1,newClient:!1,reports:!1,editClientGroup:!1,editClient:!1,viewClient:!1,editImg:!1};var T=function(e){n.views={client:!1,newClientGroup:!1,newClient:!1,reports:!1,editImg:!1},e=="viewClient"&&N(),e=="reports"&&_.isUndefined(E)&&C(),n.views[e]=!0},N=function(){e.statusBar.display(e.ui.teamup.loadingReports),i.all(n.client.uuid).then(function(t){e.statusBar.off(),n.reports=n.processReports(t)})},C=function(){e.statusBar.display(e.ui.teamup.loadingReports),n.clientGroup||(n.clientGroup=u.clientGroups[0]),i.allByClientGroup(n.clientGroup.id).then(function(t){e.statusBar.off(),n.groupReports=n.processReports(t),n.currentCLient!=0&&n.requestReportsByFilter();var i=r.search().reportUuid;if(i){var s=_.findWhere(n.groupReports,{uuid:i})||null;if(s==null){r.search().reportUuid&&r.search("reportUuid",null),e.notifier.error(e.ui.teamup.reportNotExists);return}n.openReport(s)}})};T(x),k(S),n.requestClientGroup=function(e,t){k(e),n.$watch(r.search(),function(){r.search({uuid:e})}),t&&(r.hash()!="client"&&r.hash("client"),T("client"))},n.processReports=function(e){var t=[];return angular.forEach(e,function(e){t.push({uuid:e.uuid,title:e.title,creationTime:e.creationTime,clientUuid:e.clientUuid,body:e.body,media:e.media||[],author:n.$root.getTeamMemberById(e.authorUuid),client:n.$root.getClientByID(e.clientUuid),filtered:"false"})}),t},n.setViewTo=function(e){n.$watch(e,function(){n.clientGroup||(n.clientGroup=n.clientGroups[0]),(r.hash()=="viewClient"||r.hash()=="editClient"||r.hash()=="editImg")&&e=="client"&&r.path("/client").search({uuid:n.clientGroup.id}),r.hash(e),T(e)})},n.editClientGroup=function(e){n.cGroupEditForm={name:e.name,id:e.id},n.views.editClientGroup=!0},n.cancelClientGroupEdit=function(e){n.cGroupEditForm={name:e.name,id:e.id},n.views.editClientGroup=!1},n.changeClientGroup=function(t){if($.trim(t.name)=="")return;d._("clientGroupUpdate",{second:t.id},t.id).then(function(r){r.error?e.notifier.error(e.ui.teamup.errorSaveClientGroup):(e.statusBar.display(e.ui.teamup.refreshing),s.query(!1).then(function(){e.notifier.success(e.ui.teamup.dataChanged),e.statusBar.off(),n.clientGroup.name=t.name,n.views.editClientGroup=!1}))})};var L=function(t){s.query(!1,t).then(function(i){i.error?console.warn("error ->",i):(e.notifier.success(e.ui.teamup.dataChanged),n.closeTabs(),n.data=i,n.clientGroups=i.clientGroups,n.clients=i.clients,angular.forEach(i.clientGroups,function(e){e.id==t.uuid&&(n.clientGroup=e,n.current=e.id,r.url("/client?uuid="+e.id).hash("client"))})),e.statusBar.off()})};n.cGroupSubmit=function(t){if(typeof t=="undefined"||$.trim(t.name)==""){e.notifier.error(e.ui.teamup.teamNamePrompt1);return}d._("clientGroupAdd",null,t,{success:function(e){l("app").save(e.id,e)}}).then(function(t){t.error||(e.statusBar.display(e.ui.teamup.refreshing),L({uuid:t.id}))})},n.closeTabs=function(){n.clientGroupForm={},n.clientForm={},T("client")},n.changeContacts=function(t){if(typeof n.contactForm=="undefined"||n.contactForm.func==""||n.contactForm.name!=null){e.notifier.error(e.ui.teamup.teamNamePrompt2);return}if(e.phoneNumberParsed.result==0){e.notifier.error(e.ui.validation.phone.notValid);return}e.phoneNumberParsed.result==1&&(n.contactForm.phone=e.phoneNumberParsed.format);if(!_.isNumber(t)){var r={firstName:"",lastName:"","function":"",phone:""};r.firstName=n.contactForm.firstName,r.lastName=n.contactForm.lastName,r.function=n.contactForm.function,r.phone=n.contactForm.phone,typeof n.contacts=="undefined"&&(n.contacts=[]),n.contacts==null&&(n.contacts=[]),n.contacts.push(r)}n.contactForm=null,e.resetPhoneNumberChecker()},n.editContact=function(e,t){n.contactForm=e,n.contactForm.index=t},n.clientSubmit=function(t){if(typeof t=="undefined"||!t.firstName||!t.lastName||!t.phone){e.notifier.error(e.ui.teamup.clinetInfoFill);return}e.statusBar.display(e.ui.teamup.savingClient);try{t.birthDate=c.convert.absolute(t.birthDate,0)}catch(r){e.notifier.error(e.ui.teamup.birthdayError);return}if(e.phoneNumberParsed.result==0){e.notifier.error(e.ui.validation.phone.notValid);return}e.phoneNumberParsed.result==1&&(t.phone=e.phoneNumberParsed.format),t.clientGroupUuid=n.clientGroup.id,d._("clientAdd",null,t,{success:function(e){l("app").save(e.id,e)}}).then(function(t){t.error?e.notifier.error(e.ui.teamup.clientSubmitError):(n.contactForm=null,e.resetPhoneNumberChecker(),L({uuid:t.clientGroupUuid}))})},n.clientChange=function(t){t.address&&!t.address.city&&!t.address.country&&!t.address.latitude&&!t.address.longitude&&!t.address.street&&!t.address.zip&&(t.address=null);if(e.phoneNumberParsed.result==0){e.notifier.error(e.ui.validation.phone.notValid);return}e.phoneNumberParsed.result==1&&(t.phone=e.phoneNumberParsed.format),e.statusBar.display(e.ui.teamup.savingClient);var r=angular.copy(t);try{r.birthDate=c.convert.absolute(t.birthDate,0)}catch(i){e.notifier.error(e.ui.teamup.birthdayError);return}s.singleUpdate(r).then(function(t){if(t.error)e.notifier.error(e.ui.teamup.clientSubmitError);else{e.resetPhoneNumberChecker(),e.statusBar.display(e.ui.teamup.refreshing);var r=t.clientGroupUuid?t.clientGroupUuid:n.clientGroups[0].id;L({uuid:r}),e.notifier.success(e.ui.teamup.dataChanged)}})},n.saveContacts=function(t){var r=n.client;try{r.birthDate=c.convert.absolute(r.birthDate,0)}catch(i){e.notifier.error(e.ui.teamup.birthdayError);return}r.contacts=t,e.statusBar.display(e.ui.teamup.savingContacts),d._("clientUpdate",{second:r.uuid},r).then(function(t){t.error?e.notifier.error(e.ui.teamup.clientSubmitError):(e.notifier.success(e.ui.teamup.dataChanged),e.statusBar.off(),s.query(!1,{uuid:t.clientGroupUuid}).then(function(e){})),n.client.birthDate=h("nicelyDate")(n.client.birthDate)})},n.removeContact=function(e){var t=n.contacts.indexOf(e);n.contacts.splice(t,1),angular.element("#confirmContactModal").modal("hide")},n.confirmationRemoveContact=function(e){v(function(){n._contact=e,angular.element("#confirmContactModal").modal("show")})},n.confirmDeleteClientGroup=function(){v(function(){angular.element("#confirmClientGroupModal").modal("show")})},n.deleteClientGroup=function(){angular.element("#confirmClientGroupModal").modal("hide"),e.statusBar.display(e.ui.teamup.deletingClientGroup),d._("clientGroupDelete",{second:n.current}).then(function(t){t.id&&s.query(!0,{}).then(function(e){n.requestClientGroup(e[0].id),angular.forEach(n.clientGroups,function(e,r){e.id==t.id&&n.clientGroups.splice(r,1)})},function(e){console.log(e)}),e.notifier.success(e.ui.teamup.dataChanged),e.statusBar.off()},function(e){console.log(e)})},n._clientId={},n.confirmDeleteClient=function(e){v(function(){n._clientId=e,angular.element("#confirmClientModal").modal("show")})},n.deleteClient=function(t){n._clientId={},angular.element("#confirmClientModal").modal("hide"),e.statusBar.display(e.ui.teamup.deletingClient),d._("clientDelete",{second:t}).then(function(){d._("clientsQuery").then(function(e){l("app").save("clients",e),n.views.viewClient==1?n.setViewTo("client"):a.reload()})},function(e){console.log(e)})};var A=function(e,t){n.currentCLient=e,n.currentMonth=moment(t).format("M"),n.requestReportsByFilter()};n.requestReportsByFilter=function(){angular.forEach(n.groupReports,function(e){e.clientUuid!=n.currentCLient&&n.currentCLient!="0"?e.filtered="true":e.filtered="false";var t=(new Date(e.creationTime)).getMonth()+1;t!=n.currentMonth&&n.currentMonth!="0"||e.filtered=="true"?e.filtered="true":e.filtered="false"})},n.getView=function(e){n.view=n.view||{},n.view.editReport=!!e.editMode,n.view.viewReport=!e.editMode&&typeof e.uuid!="undefined",n.view.newReport=typeof e.uuid=="undefined"},n.close=function(){r.search().reportUuid&&r.search("reportUuid",null),g.hide()},n.saveReport=function(t){if(_.isEmpty(t.title)||_.isEmpty(t.body)){e.notifier.error(e.ui.teamup.reportEmpty);return}t.editMode?i.update(t).then(function(r){n.close(t),e.notifier.success(e.ui.teamup.dataChanged),C()}):i.save(t).then(function(r){n.close(t),e.notifier.success(e.ui.teamup.dataChanged),C(),A(t.clientUuid,t.creationTime)})},n.openReport=function(e){_.isUndefined(E)||A(e.clientUuid,e.creationTime),trackGa("send","event","Report","User is viewing a report"),n.report=e,n.report.editMode=!1,g=O()},n.newReport=function(){if(n.currentCLient==0){e.notifier.error(e.ui.teamup.selectClient);return}n.report={title:e.ui.teamup.newReport,creationTime:(new Date).getTime(),clientUuid:n.currentCLient,body:null,author:n.$root.getTeamMemberById(e.app.resources.uuid),client:n.$root.getClientByID(n.currentCLient),editMode:!1},trackGa("send","event","Report","User creates report"),g=O()},n.editReport=function(e){n.report=e,n.report.editMode=!0,g=O()},n._report={},n.confirmDeleteReport=function(e){v(function(){n._report=e,angular.element("#confirmReportModal").modal("show")})},n.removeReport=function(t){e.statusBar.display(e.ui.teamup.loading),n._report={},angular.element("#confirmReportModal").modal("hide"),i.remove(t.clientUuid,t.uuid).then(function(t){t.result=="ok"&&(e.notifier.success(e.ui.teamup.dataChanged),C(),n.views.viewClient==1&&N())})},n.editImg=function(){n.uploadURL=n.imgHost+n.ns+"/client/"+n.client.uuid+"/photo?square=true",n.setViewTo("editImg")}}])});