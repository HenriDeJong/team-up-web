define(["controllers/controllers"],function(e){e.controller("dashboard",function(e,t,n,r,i,s,o,u,a){t.notification.status=!1,t.fixStyles();var f=a("app").get("teams"),l=function(e){return e.role>0&&e.role<4},c=function(e){return _.indexBy(_.filter(_.map(_.indexBy(e,function(e){return e.uuid}),function(e){return e}),l),function(e){return e.uuid})},h=c(a("app").get("members")),p;f.unshift({name:t.ui.dashboard.everyone,uuid:"all"}),p="all",e.groups=f,e.states=t.config.app.timeline.config.states,e.states["no-state"]={className:"no-state",label:t.ui.dashboard.possiblyAvailable,color:"#ececec",type:t.ui.dashboard.noPlanning,display:!1},e.current={group:p,division:"all"},e.loadingAvailability=!0,e.getAvailability=function(r,i){var u=n.defer(),f=o.query();return r||(r=e.current.group),i||(i=e.current.division),f.then(function(n){r=="all"?h=c(a("app").get("members")):typeof n.members[r]!="undefined"&&(h=c(n.members[r])),s.users(h).then(function(n){var r={};_.each(angular.fromJson(angular.toJson(n.members)),function(n,i){if(h[i]&&h[i].role!=0&&h[i].role!=4){var s={id:i,state:n.length>0?n[0].state:"no-state",label:n.length>0?e.states[n[0].state].label[0]:"",end:n.length>0&&n[0].end!==undefined?n[0].end*1e3:t.ui.dashboard.possiblyAvailable,name:h&&h[i]?h[i].firstName+" "+h[i].lastName:i};n.length>0?(r.available||(r.available=[]),r.unavailable||(r.unavailable=[]),n[0].state=="com.ask-cs.State.Unreached"?r.unavailable.push(s):n[0].state=="com.ask-cs.State.Unavailable"?r.unavailable.push(s):(n[0].state=="com.ask-cs.State.Available"&&(s.style="sa-icon-reserve-available"),n[0].state=="com.ask-cs.State.KNRM.BeschikbaarNoord"&&(s.style="sa-icon-reserve-available-north"),n[0].state=="com.ask-cs.State.KNRM.BeschikbaarZuid"&&(s.style="sa-icon-reserve-available-south"),n[0].state=="com.ask-cs.State.KNRM.SchipperVanDienst"&&(s.style="sa-icon-reserve-available-schipper"),r.available.push(s))):(r.possible||(r.possible=[]),r.possible.push(s))}}),e.loadingAvailability=!1;var i=function(e,t){return e.end<t.end?-1:e.end>t.end?1:0};r.hasOwnProperty("available")&&r.available.sort(i),r.hasOwnProperty("unavailable")&&r.unavailable.sort(i);var s=[];_.each(r.available,function(e){e.state=="com.ask-cs.State.KNRM.SchipperVanDienst"&&s.push(e)}),_.each(r.available,function(e){e.state=="com.ask-cs.State.Available"&&s.push(e)}),_.each(r.available,function(e){e.state=="com.ask-cs.State.KNRM.BeschikbaarNoord"&&s.push(e)}),_.each(r.available,function(e){e.state=="com.ask-cs.State.KNRM.BeschikbaarZuid"&&s.push(e)}),r.available=s,e.availability={members:r,synced:n.synced*1e3},u.resolve(e.availability)},function(e){u.reject(e)})}),u.promise},e.getGroupAvailability=function(){var t=n.defer();return e.current.division="all",e.getAvailability(e.current.group,e.current.division).then(function(e){t.resolve(e)},function(e){t.reject(e)}),t.promise},e.getDivisionAvailability=function(){e.getAvailability(e.current.group,e.current.division)},t.config.app.presence?n.all([e.getGroupAvailability(),Network.population()]).then(function(){e.checkPresence()},function(){e.getGroupAvailability().then(function(){e.checkPresence()})}):e.getGroupAvailability(),e.setPrefixedAvailability=function(e,t){a("environment").save("setPrefixedAvailability",{availability:e,period:t}),i.path("/planboard").search({setPrefixedAvailability:!0})}})});