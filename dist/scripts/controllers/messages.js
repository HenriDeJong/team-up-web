define(["controllers/controllers","config"],function(e,t){e.controller("messagesCtrl",["$scope","$rootScope","$q","$location","$route","$filter","Teams","TeamUp",function(e,n,r,i,s,o,u,a){var f=2e3,l=5e3,c=6048e5;e.messages=[],e.messagesShow=[],e.teamName="",e.latestMsgTime=0,n.$on("taskFinishLoading",function(t,r){angular.isArray(n.app.resources.teamUuids)&&(e.teamName=n.getTeamName(n.app.resources.teamUuids[0]),e.chatTeamId=n.app.resources.teamUuids[0].uuid,e.chatTeamId&&!e.toggleChat&&setTimeout(e.checkMessage,l))}),e.formatMessage=function(t){var r=[],i=function(e){var t=/(https?:\/\/[^\s]+)/g,n=null;return t.test(e)?n=e.replace(t,function(e){return'<a href="'+e+'" target="_blank">'+"Klik"+"</a>"}):n=e,n};angular.forEach(t,function(s,u){var a=o("getByUuid")(e.messages,s.uuid);if(a)return;var f=o("nicelyDate")(parseInt(s.sendTime));u>0&&f==o("nicelyDate")(parseInt(t[u-1].sendTime))&&(f="");var l={date:f,role:"",member:{},senderName:"",sendTime:parseInt(s.sendTime),body:s.body,msgRole:"",senderUuid:s.senderUuid,uuid:s.uuid,type:s.type,title:s.title},h=n.getTeamMemberById(s.senderUuid);s.senderUuid==e.$root.app.resources.uuid?(l.role="own",l.msgRole="messageOwn",l.member=e.$root.app.resources,l.senderName=l.member.firstName+" "+l.member.lastName):(l.role="other",l.msgRole="messageOther",l.member=h,l.senderName=h.firstName+" "+h.lastName);if(l.type=="REPORT_NEW"){var p=JSON.parse(s.body);if(p&&p.clientUuid!=null){console.log("msgBody.clientUuid",p.clientUuid);var d=n.getClientByID(p.clientUuid);d!=null&&(angular.extend(p,{clientGroupId:d.clientGroupUuid}),l.body=p,l.title=e.ui.message.reportMessage+" "+d.firstName+" "+d.lastName)}}else l.body=i(l.body);e.messages.push(l);var v=new Date;v.getTime()-parseInt(s.sendTime)<=c&&e.messagesShow.push(l),r.indexOf(s.senderUuid)==-1&&r.push(s.senderUuid)})},e.renderMessage=function(t){a._("chats",{third:e.chatTeamId,since:e.latestMsgTime}).then(function(t){if(t.error){n.notifier.error(t.error.data);return}t=o("orderBy")(t,"sendTime"),e.formatMessage(t),e.moveToBottom&&setTimeout(function(){angular.element("#chat-content #messageField").focus(),angular.element("#chat-content .mainContent").scrollTop(angular.element("#chat-content .mainContent")[0].scrollHeight),e.moveToBottom=!1},1e3),e.toggleChat&&(e.latestMsgTime=t[t.length-1].sendTime,setTimeout(e.renderMessage,f))},function(e){console.log(e)})},e.checkMessage=function(t){a._("chats",{third:e.chatTeamId,since:e.latestMsgTime}).then(function(t){if(t.error){n.notifier.error(t.error.data);return}e.newCount=0,angular.forEach(t,function(t){o("getByUuid")(e.messages,t.uuid)||e.newCount++}),e.newCount==0||e.messages.length==0?e.unReadCount==0||typeof e.unReadCount=="undefined"?e.newCountShow="":e.newCountShow="("+e.unReadCount+")":(e.unReadCount=e.newCount+(typeof e.unReadCount=="undefined"?0:e.unReadCount),e.newCountShow="("+e.unReadCount+")"),$("#chat-btn").animate({"background-color":"yellow"},"slow").animate({"background-color":"#1dc8b6"},"slow"),e.toggleChat||(t=o("orderBy")(t,"sendTime"),(e.messages.length==0||!e.newCount==0&&!e.newCount=="")&&e.formatMessage(t),e.latestMsgTime=t[t.length-1].sendTime,setTimeout(e.checkMessage,l))})},e.openChat=function(){e.toggleChat=!e.toggleChat;var t=n.app.resources.teamUuids;e.chatTeamId=t[0];var r=o("orderBy")(e.messages,"sendTime"),i=0;r.length>0&&(e.latestMsgTime=r[r.length-1].sendTime),e.chatTeamId?e.toggleChat?(e.renderMessage(i),e.newCountShow="",e.unReadCount=0,e.moveToBottom=!0):setTimeout(e.checkMessage,l):console.log("login user doesn't belong to any team.")},e.openVideo=function(){var r=function(){return Math.random().toString(36).slice(-8)},i=r(),s=new Date,o=" http://webrtc.ask-fast.com/?room="+r(),u=n.ui.message.webTRCWebLink+o;n.statusBar.display(n.ui.message.sending),a._("message",{},{title:"Van: TeamUp"+s.toString(t.app.formats.date),body:u,sendTime:s.getTime()}).then(function(){n.statusBar.off(),e.moveToBottom=!0,window.open(o,"_blank")},function(e){n.notifier.error(e),n.statusBar.off()})},e.sendMessage=function(r){if(typeof r=="undefined"||r==""){n.notifier.error(n.ui.message.emptyMessageBody);return}n.statusBar.display(n.ui.message.sending);var i=new Date;a._("message",{},{title:"Van: TeamUp"+i.toString(t.app.formats.date),body:r,sendTime:i.getTime()}).then(function(){n.statusBar.off(),e.newMessage="",e.moveToBottom=!0},function(e){n.notifier.error(e),n.statusBar.off()})}}])});