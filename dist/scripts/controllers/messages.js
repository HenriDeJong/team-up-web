define(["controllers/controllers","config"],function(e,t){e.controller("messagesCtrl",["$scope","$rootScope","$q","$location","$route","$filter","Teams","TeamUp",function(e,n,r,i,s,o,u,a){var f=5e4;e.messages=[],e.renderMessage=function(){a._("chats",{third:e.chatTeamId}).then(function(t){if(t.error){n.notifier.error(t.error.data);return}if(e.messages.length==t.length){console.log("No new messages.");return}e.messages=[];var r=[];t=o("orderBy")(t,"sendTime"),angular.forEach(t,function(i,s){var u=o("nicelyDate")(parseInt(i.sendTime));s>0&&u==o("nicelyDate")(parseInt(t[s-1].sendTime))&&(u="");var a={date:u,role:"",member:{},senderName:"",sendTime:parseInt(i.sendTime),body:i.body,msgRole:"",senderUuid:i.senderUuid},f=n.getTeamMemberById(i.senderUuid);i.senderUuid==e.$root.app.resources.uuid?(a.role="own",a.msgRole="messageOwn",a.member=e.$root.app.resources,a.senderName=a.member.firstName+" "+a.member.lastName):(a.role="other",a.msgRole="messageOther",a.member=f,a.senderName=f.firstName+" "+f.lastName),e.messages.push(a),r.indexOf(i.senderUuid)==-1&&r.push(i.senderUuid)}),setTimeout(function(){angular.element("#chat-content #messageField").focus(),angular.element("#chat-content").scrollTop(angular.element("#chat-content")[0].scrollHeight)},1e5)},function(e){console.log(e)})},e.openChat=function(){e.toggleChat=!e.toggleChat;var t=n.app.resources.teamUuids;t&&e.toggleChat?(e.chatTeamId=t[0],e.renderMessage(),e.autoCheckMonitorId=setInterval(e.renderMessage,f)):clearInterval(e.autoCheckMonitorId)},e.sendMessage=function(r){if(typeof r=="undefined"||r==""){n.notifier.error(n.ui.message.emptyMessageBody);return}n.statusBar.display(n.ui.message.sending);var i=new Date;a._("message",{},{title:"Van: TeamUp"+i.toString(t.app.formats.date),body:r,sendTime:i.getTime()}).then(function(){e.renderMessage(),n.statusBar.off(),e.newMessage=""},function(e){n.notifier.error(e),n.statusBar.off()})}}])});