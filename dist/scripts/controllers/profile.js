define(["controllers/controllers","config"],function(e,t){e.controller("profileCtrl",["$rootScope","$scope","$q","$location","$window","$route","data","Store","Teams","Dater","$filter","TeamUp","$timeout","MD5","Profile",function(e,n,r,i,s,o,u,a,f,l,c,h,p,d,v){function b(t){n.views={profile:!1,edit:!1,editImg:!1,editPassword:!1},n.views[t]=!0,n.views.user=e.app.resources.uuid==o.current.params.userId}function S(e){return moment(e).format("DD-MM-YYYY")}function x(e){return moment(l.convert.absolute(e,0)).format("YYYY-MM-DD")}var m=null;e.fixStyles(),n.self=this,n.roles=t.app.roles,n.mfuncs=t.app.mfunctions,n.data=u,n.noImgURL=t.app.noImgURL,n.profilemeta=u,n.profilemeta.birthDate=S(n.profilemeta.birthDate),n.profile=angular.copy(n.profilemeta);var g=function(e,t){v.get(e,t).then(function(e){m=e,n.profile.pincode=m.pincode?m.pincode:"",n.profile.phoneNumbers=m.phones||[],n.data.phoneNumbers=n.profile.phoneNumbers})};g(n.profilemeta.uuid),n.currentRole=n.profilemeta.role,e.browser.mobile&&(n.profile.birthDate=x(n.profile.birthDate)),n.imgHost=t.app.host,n.ns=t.app.namespace;var y=[];n.selectTeams=a("app").get("teams");var y=n.$root.getTeamsofMembers(n.profilemeta.uuid);n.teams=y,n.forms={add:!1,edit:!1},b(i.hash()),n.setViewTo=function(e){n.$watch(i.hash(),function(){i.hash(e),b(e)})},n.$watch(function(){return n.profile.pincode},function(){n.pincodeExists()});var w=250;n.pincodeExistsValidation=!0,n.pincodeExists=function(){!angular.isDefined(n.profile.pincode)||n.profile.pincode==""?(n.pincodeExistsValidation=!1,n.pincodeExistsValidationMessage=e.ui.profile.pincodeNotValid):angular.isDefined(n.profile.pincode)&&(n.checkPincode&&(clearTimeout(n.checkPincode),n.checkPincode=null),n.checkPincode=setTimeout(function(){n.checkPincode=null,v.pincodeExists(n.profilemeta.uuid,n.profile.pincode).then(function(t){n.pincodeExistsValidation=t,n.pincodeExistsValidationMessage=e.ui.profile.pincodeInUse})},w))},n.parsedPhoneNumbers=[],n.resetPhoneNumberCheck=function(){_.each([0,1,2],function(e){n.parsedPhoneNumbers[e]={}})},n.checkPhoneNumber=function(t,r){e.parsePhoneNumber(t,r),n.parsedPhoneNumbers[r]=e.phoneNumberParsed,e.resetPhoneNumberChecker()},n.checkPincode=null,n.teamMemberCodeConfirmed=function(){angular.element("#confirmTeamMemberCodeAsPhoneModal").modal("hide"),n.profile.TeamMemberCodeAsPhone=!0,n.save(n.profile)},n.setTeamMemberCodeAsPhone=function(e){e&&e.length>=12&&m.pincode!=n.profile.pincode&&(n.profile.pincode=e.substr(e.length-4))},n.save=function(t){if(!t.phoneNumbers[0])return e.notifier.error(e.ui.validation.phone.notValidOnSubmit),!1;if(!n.pincodeExistsValidation)return e.notifier.error(e.ui.profile.pincodeNotValid),!1;if(t.pincode==t.phoneNumbers[0].substr(t.phoneNumbers[0].length-4)&&!t.TeamMemberCodeAsPhone)return p(function(){angular.element("#confirmTeamMemberCodeAsPhoneModal").modal("show")}),!1;if(n.currentRole!=t.role&&e.app.resources.uuid==t.uuid&&!confirm(e.ui.profile.roleChangePrompt))return!1;if(t.teamUuids==null||typeof t.teamUuids[0]=="undefined"){t.teamUuids=[],n.teams.length==0?t.teamUuids.push(sessionStorage.getItem(t.uuid+"_team")):t.teamUuids.push(n.teams[0].uuid);if(t.teamUuids[0]==null)return e.notifier.error(e.ui.profile.specifyTeam),!1}if(_.isUndefined(t.email)||t.email==0)return e.notifier.error(e.ui.validation.email.notValid),!1;var r=!0;_.each(t.phoneNumbers,function(e,i){!_.isEmpty(e)&&!_.isUndefined(e)&&!_.isUndefined(n.parsedPhoneNumbers[i])&&n.parsedPhoneNumbers[i].result==1?t.phoneNumbers[i]=n.parsedPhoneNumbers[i].format:!_.isEmpty(e)&&!_.isUndefined(e)&&!_.isUndefined(n.parsedPhoneNumbers[i])&&n.parsedPhoneNumbers[i].result==0&&(r=!1)});if(!r)return e.notifier.error(e.ui.validation.phone.multipleNotvalid),!1;t.phoneNumbers=_.without(t.phoneNumbers,undefined),n.resetPhoneNumberCheck();if(e.browser.mobile){var i=t.birthDate,s=i.substr(i.length-2),u=i.substr(5,2),a=i.substr(0,4);t.birthDate=s+"-"+u+"-"+a}try{t.birthDate=l.convert.absolute(t.birthDate,0)}catch(f){return e.notifier.error(e.ui.teamup.birthdayError),!1}e.statusBar.display(e.ui.profile.saveProfile),m.phones=t.phoneNumbers,t.phone=t.phoneNumbers[0],m.pincode=t.pincode,delete t.phoneNumbers,delete t.birthday,delete t.fullName,delete t.TeamMemberCodeAsPhone,delete t.pincode,_.isUndefined(t.oldpass)||delete t.oldpass,v.save(o.current.params.userId,m).then(function(n){n.error?(e.notifier.error(e.ui.errors.profile.save),console.warn("error ->",n)):E(t)})};var E=function(t){h._("profileSave",{second:t.teamUuids[0],fourth:t.uuid},t).then(function(r){console.log("resources.birthDate",r),r.error?(e.notifier.error("Error with saving profile information."),console.warn("error ->",r)):(e.statusBar.display(e.ui.profile.refreshing),h._("profileGet",{third:o.current.params.userId},null,function(t){o.current.params.userId==e.app.resources.uuid&&(e.app.resources=r,a("app").save("resources",t))}).then(function(r){r.error?(e.notifier.error("Error with getting profile data."),console.warn("error ->",r)):(e.notifier.success(e.ui.profile.dataChanged),console.log("data",r),n.data=r,n.data.birthDate=S(n.data.birthDate),g(o.current.params.userId,o.current.params.userId==e.app.resources.uuid),n.data.phoneNumbers=m.phones,n.profile=angular.copy(n.data),console.log("$scope.data",n.data.birthDate),e.browser.mobile&&(n.profile.birthDate=x(n.data.birthDate)),e.statusBar.off(),n.setViewTo("profile"),e.app.resources.uuid==o.current.params.userId&&(e.app.resources.firstName=n.profile.firstName,e.app.resources.lastName=n.profile.lastName,n.currentRole!=t.role&&e.nav("logout")),angular.forEach(t.teamUuids,function(t){f.query(!1,{uuid:t}).then(function(){e.statusBar.off()})}))}))})};n.editProfile=function(){b("edit")},n.editPassword=function(){b("editPassword")},n.editImg=function(){n.uploadURL=n.imgHost+n.ns+"/team/member/"+o.current.params.userId+"/photo?square=true",n.setViewTo("editImg")},n.confirmDeleteProfile=function(){p(function(){angular.element("#confirmProfileModal").modal("show")})},n.savePassword=function(t){var r=angular.copy(t);if(!r.oldpass||!r.newpass||!r.newpassrepeat){e.notifier.error(e.ui.profile.pleaseFill);return}if(r.newpass!=null&&r.newpass!=r.newpassrepeat){e.notifier.error(e.ui.profile.passNotMatch);return}if(d(r.oldpass)!==n.profile.passwordHash){e.notifier.error(e.ui.profile.currentPassWrong);return}r.newpass!=null&&(n.data.passwordHash=d(r.newpass),delete r.oldpass,delete r.newpass,delete r.newpassrepeat),n.save(n.data)},n.deleteProfile=function(){angular.element("#confirmProfileModal").modal("hide"),e.statusBar.display(e.ui.teamup.deletingMember);var t;angular.forEach(n.teams,function(t){h._("teamMemberDelete",{second:t.uuid},{ids:[n.profilemeta.uuid]}).then(function(r){e.notifier.success(e.ui.teamup.dataChanged),angular.forEach(n.profilemeta.teamUuids,function(r,i){t.uuid==r&&(e.statusBar.display(e.ui.teamup.refreshing),f.query(!1,{uuid:r}).then(function(){e.statusBar.off()}),n.profilemeta.teamUuids.splice(i,1),n.teams.splice(i,1),sessionStorage.removeItem(u.uuid+"_team"),f.updateMembersLocal())})},function(e){console.log(e)}),h._("teamMemberFree").then(function(t){a("app").save("members",t),e.statusBar.off()},function(e){console.log(e)})})}}])});