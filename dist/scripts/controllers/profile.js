define(["controllers/controllers","config"],function(e,t){e.controller("profileCtrl",["$rootScope","$scope","$q","$location","$window","$route","data","Store","Teams","Dater","$filter","TeamUp","$timeout","MD5","Profile",function(e,n,r,i,s,o,u,a,f,l,c,h,p,d,v){function y(t){n.views={profile:!1,edit:!1,editImg:!1,editPassword:!1},n.views[t]=!0,n.views.user=e.app.resources.uuid==o.current.params.userId}var m=function(e,t){v.get(e,t).then(function(e){e&&(n.view.pincode=angular.copy(e.pincode)||"",n.view.phoneNumbers=angular.copy(e.PhoneAddresses)||[],n.edit=angular.copy(n.view))})};e.fixStyles(),n.roles=t.app.roles,n.mfuncs=t.app.mfunctions,n.view=u,n.view.birthDate=l.formatDate(n.view.birthDate),n.noImgURL=t.app.noImgURL,n.edit=angular.copy(n.view),m(n.view.uuid);var g=n.view.role;e.browser.mobile&&(n.edit.birthDate=l.formatDateMobile(n.edit.birthDate)),n.teams=e.getTeamsofMembers(n.view.uuid),n.forms={add:!1,edit:!1},y(i.hash()),n.setViewTo=function(e){n.$watch(i.hash(),function(){i.hash(e),y(e)})},n.$watch(function(){return n.edit.pincode},n.pincodeExists),n.pincodeExistsValidation=!0,n.pincodeExists=function(){var t=250;!angular.isDefined(n.edit.pincode)||n.edit.pincode==""?(n.pincodeExistsValidation=!1,n.pincodeExistsValidationMessage=e.ui.profile.pincodeNotValid):angular.isDefined(n.edit.pincode)&&(n.checkPincode&&(clearTimeout(n.checkPincode),n.checkPincode=null),n.checkPincode=setTimeout(function(){n.checkPincode=null,v.pincodeExists(n.view.uuid,n.edit.pincode).then(function(t){n.pincodeExistsValidation=t,n.pincodeExistsValidationMessage=e.ui.profile.pincodeInUse})},t))},n.parsedPhoneNumbers=[],n.resetPhoneNumberCheck=function(){_.each([0,1,2],function(e){n.parsedPhoneNumbers[e]={}})},n.checkPhoneNumber=function(t,r){e.parsePhoneNumber(t,r),n.parsedPhoneNumbers[r]=e.phoneNumberParsed,e.resetPhoneNumberChecker()},n.checkPincode=null,n.setTeamMemberCodeAsPhone=function(e){var t=n.edit.phoneNumbers[e],r=n.parsedPhoneNumbers[e].result;if(t&&t.length>=10&&(_.isEmpty(n.edit.pincode)||n.view.pincode!=n.edit.pincode||b(n.view.phoneNumbers[e])==n.view.pincode)&&r==1){var i=angular.element(".inputPhoneNumber0").val();n.edit.pincode=b(i)}};var b=function(e){return e.substr(e.length-4)};n.save=function(t){if(!t.phoneNumbers[0])return e.notifier.error(e.ui.validation.phone.notValidOnSubmit),!1;if(g!=t.role&&e.app.resources.uuid==t.uuid&&!confirm(e.ui.profile.roleChangePrompt))return!1;if(_.isNull(t.teamUuids)||_.isUndefined(t.teamUuids[0])){t.teamUuids=[],n.teams.length==0?t.teamUuids.push(sessionStorage.getItem(t.uuid+"_team")):t.teamUuids.push(n.teams[0].uuid);if(t.teamUuids[0]==null)return e.notifier.error(e.ui.profile.specifyTeam),!1}if(_.isUndefined(t.email)||t.email==0)return e.notifier.error(e.ui.validation.email.notValid),!1;var r=!0;_.each(t.phoneNumbers,function(e,i){!_.isEmpty(e)&&!_.isUndefined(e)&&!_.isUndefined(n.parsedPhoneNumbers[i])&&n.parsedPhoneNumbers[i].result==1?t.phoneNumbers[i]=n.parsedPhoneNumbers[i].format:!_.isEmpty(e)&&!_.isUndefined(e)&&!_.isUndefined(n.parsedPhoneNumbers[i])&&n.parsedPhoneNumbers[i].result==0&&(r=!1)});if(!r)return e.notifier.error(e.ui.validation.phone.multipleNotvalid),!1;t.phoneNumbers=_.without(t.phoneNumbers,undefined),n.resetPhoneNumberCheck();if(e.browser.mobile){var i=t.birthDate,s=i.substr(i.length-2),u=i.substr(5,2),a=i.substr(0,4);t.birthDate=s+"-"+u+"-"+a}try{t.birthDate=l.convert.absolute(t.birthDate,0)}catch(f){return e.notifier.error(e.ui.teamup.birthdayError),!1}e.statusBar.display(e.ui.profile.saveProfile),t.phone=t.phoneNumbers[0],delete t.birthday,delete t.fullName,_.isUndefined(t.oldpass)||delete t.oldpass,v.save(o.current.params.userId,{PhoneAddresses:t.phoneNumbers,pincode:t.pincode}).then(function(n){n.error?(e.notifier.error(e.ui.errors.profile.save),console.warn("error ->",n)):(delete t.phoneNumbers,delete t.pincode,w(t))})};var w=function(t){v.saveUserData(t).then(function(r){r.error?(e.notifier.error("Error with saving profile information."),console.warn("error ->",r)):v.fetchUserData(o.current.params.userId).then(function(r){r.error?(e.notifier.error("Error with getting profile data."),console.warn("error ->",r)):(e.notifier.success(e.ui.profile.dataChanged),n.view=r,n.view.birthDate=l.formatDate(n.view.birthDate),m(o.current.params.userId,o.current.params.userId==e.app.resources.uuid),e.browser.mobile?n.edit.birthDate=l.formatDateMobile(n.view.birthDate):n.edit.birthDate=n.view.birthDate,e.statusBar.off(),n.setViewTo("profile"),e.app.resources.uuid==o.current.params.userId&&(e.app.resources.firstName=n.edit.firstName,e.app.resources.lastName=n.edit.lastName,g!=n.view.role&&e.nav("logout")),angular.forEach(t.teamUuids,function(t){f.query(!1,{uuid:t}).then(function(){e.statusBar.off()})}))})})};n.editProfile=function(){y("edit")},n.editPassword=function(){y("editPassword")},n.editImg=function(){n.uploadURL=t.app.host+t.app.namespace+"/team/member/"+o.current.params.userId+"/photo?square=true",n.setViewTo("editImg")},n.savePassword=function(t){var r=angular.copy(t);if(!r.oldpass||!r.newpass||!r.newpassrepeat){e.notifier.error(e.ui.profile.pleaseFill);return}if(r.newpass!=null&&r.newpass!=r.newpassrepeat){e.notifier.error(e.ui.profile.passNotMatch);return}if(d(r.oldpass)!==n.edit.passwordHash){e.notifier.error(e.ui.profile.currentPassWrong);return}r.newpass!=null&&(n.view.passwordHash=d(r.newpass),delete r.oldpass,delete r.newpass,delete r.newpassrepeat),n.save(n.view)},n.confirmModal=function(e){p(function(){angular.element(e).modal("show")})},n.deleteAvatar=function(){angular.element("#confirmDeleteAvatar").modal("hide")},n.deleteProfile=function(){angular.element("#confirmProfileModal").modal("hide"),e.statusBar.display(e.ui.teamup.deletingMember),angular.forEach(n.teams,function(t){h._("teamMemberDelete",{second:t.uuid},{ids:[n.view.uuid]}).then(function(r){e.notifier.success(e.ui.teamup.dataChanged),angular.forEach(n.view.teamUuids,function(r,i){t.uuid==r&&(e.statusBar.display(e.ui.teamup.refreshing),f.query(!1,{uuid:r}).then(function(){e.statusBar.off()}),n.view.teamUuids.splice(i,1),n.teams.splice(i,1),sessionStorage.removeItem(u.uuid+"_team"),f.updateMembersLocal())})},function(e){console.log(e)}),h._("teamMemberFree").then(function(t){a("app").save("members",t),e.statusBar.off()},function(e){console.log(e)})})}}])});