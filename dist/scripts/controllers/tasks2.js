define(["controllers/controllers"],function(e){e.controller("tasks2Ctrl",["$rootScope","$scope","$location","$timeout","Store","TeamUp","Task","Teams","Clients",function(e,t,n,r,i,s,o,u,a){function l(){t.tasks={mine:{loading:!0,list:[]},all:{loading:!0,list:[]}},t.views={myTasks:!1,allTasks:!1,newTask:!1},t.showAllTasks=!1,t.showOnlyAvailable=!0,t.reversed=!0,t.order="plannedStartVisitTime"}function h(e){o.queryMine().then(function(e){t.tasks.mine={loading:!1,list:e}}),e||p()}function p(){o.queryAll().then(function(e){t.tasks.all={loading:!1,list:e.on}})}function d(t,n){o.update(t).then(function(r){if(r.error){e.notifier.error(e.transError(r.error.data?r.error.data.result:r.error)),t.assignedTeamMemberUuid=null;return}h(n)})}e.fixStyles();var f=n.hash()?n.hash():"myTasks",c=function(e){l(),t.tasks=t.tasks?t.tasks:{},t.views[e]=!0,n.hash(e);switch(e){case"myTasks":var s=i("app").get("myTasks2"),o=0;s.length>0&&(t.tasks.mine={loading:!1,list:s},o=250),r(function(){h()},o);break;case"allTasks":var u=i("app").get("allTasks2");if(u.on||u.off)t.tasks.all={loading:!1,list:u.on};r(function(){p()},250);break;case"newTask":}};t.setViewTo=function(e){t.$watch(e,function(){n.hash(e),c(e)})},c(f),t.$watch("showAllTasks",function(e){var n=i("app").get("allTasks2");e?t.tasks.all.list=n.on.concat(n.off):t.tasks.all.list=n.on}),t.openTask=function(e){t.task=e,angular.element("#taskModal").modal("show")},t.orderBy=function(e){t.ordered=e,t.reversed=!t.reversed},t.assignTask=function(t){t.assignedTeamMemberUuid=e.app.resources.uuid,d(t,!0),c("myTasks")},t.unAssignTask=function(e){e.assignedTeamMemberUuid=null,e.assignedTeamUuid=null,d(e)},t._task={},t.confirmDeleteTask=function(e){r(function(){t._task=e,angular.element("#confirmTaskModal").modal("show")})},t.deleteTask=function(n){t._task={},angular.element("#confirmTaskModal").modal("hide"),s._("taskDelete",{second:n.uuid},n).then(function(t){t.error?t.error.data?e.notifier.error(t.error.data):e.notifier.error(t.error):(e.notifier.success(e.ui.task.taskDeleted),h())})};var v=u.queryLocal(),m=a.queryLocal(),g=u.queryLocalClientGroup(v.teams);t.teams=v.teams;if(t.currentTeam==null||typeof t.currentTeam=="undefined")t.currentTeam=v.teams[0].uuid;t.members=v.members[t.currentTeam],t.groups=[],t.clients=[],t.teamAffectGroup=function(){angular.forEach(m.clientGroups,function(e){t.currentGroup==e.id&&(t.groups=[],t.groups.push(e))}),t.groupAffectClient(t.currentGroup)},t.groupAffectClient=function(e){t.clients=m.clients[e],(t.curentClient==null||typeof t.curentClient=="undefined")&&t.clients&&t.clients.length>0?t.curentClient=t.clients[0].uuid:t.curentClient=null,t.task&&t.task.client&&(t.task.client=t.curentClient)},typeof g[t.currentTeam]=="undefined"?t.currentGroup=null:(t.currentGroup=g[t.currentTeam],t.teamAffectGroup(),t.groupAffectClient(t.currentGroup)),t.changeClientGroup=function(e){t.groupAffectClient(e)},t.changeTeam=function(e){t.members=v.members[e],t.currentGroup=g[e],t.teamAffectGroup()},o.chains()}])});