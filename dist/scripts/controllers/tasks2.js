define(["controllers/controllers"],function(e){e.controller("tasks2Ctrl",["$rootScope","$scope","$location","$timeout","$filter","Store","TeamUp","Task","Teams","Clients","Dater",function(e,t,n,r,i,s,o,u,a,f,l){function v(){t.tasks={mine:{loading:!0,list:[]},all:{loading:!0,list:[]}},t.views={myTasks:!1,allTasks:!1,newTask:!1,editTask:!1,upload:!1},t.showAllTasks=!1,t.showOnlyAvailable=!0,t.reversed=!0,t.order="plannedStartVisitTime"}function g(e,n){u.queryMine().then(function(e){t.tasks.mine={loading:!1,list:e.on,archieve:e.off.length>0},n&&n.call(this,e)}),e||y()}function y(e){g(!0),u.queryAll().then(function(n){t.tasks.all={loading:!1,list:n.on},e&&e.call(this,n)})}function E(e,t){return i("date")(e,t)}function S(e,t){var n=E(e,"m");return n%=15,new Date(e.getTime()-n*6e4+t*6e4)}function x(t,n){u.update(t).then(function(r){if(r.error){e.notifier.error(e.transError(r.error.data?r.error.data.result:r.error)),t.assignedTeamMemberUuid=null;return}g(n)})}e.fixStyles();var c=n.hash()||"myTasks",h=a.queryLocal(),p=f.queryLocal(),d=a.queryLocalClientGroup(h.teams);t.teams=h.teams,t.task=t.task||{team:t.currentTeam};var m=function(e){v(),t.tasks=t.tasks?t.tasks:{},t.views[e]=!0,n.hash(e);switch(e){case"myTasks":var i=s("app").get("myTasks2"),o=0;if(i.on||i.off)t.tasks.mine={loading:!1,list:i,archieve:i.off.length>0},o=250;r(function(){g()},o);break;case"allTasks":var u=s("app").get("allTasks2");if(u.on||u.off)t.tasks.all={loading:!1,list:u.on};r(function(){y()},250);break;case"editTask":break;case"newTask":break;case"upload":}};t.setViewTo=function(e){t.$watch(e,function(){n.hash(e),m(e)})},m(c),t.modifyTask=function(e){t.changeTeam(e.assignedTeamUuid),t.task={uuid:e.uuid,team:e.assignedTeamUuid,member:e.assignedTeamMemberUuid,client:e.relatedClientUuid,start:{date:new Date(e.plannedStartVisitTime),time:e.plannedStartVisitTime},end:{date:new Date(e.plannedEndVisitTime),time:e.plannedEndVisitTime},description:e.description},v(),t.views.editTask=!0},t.$watch("showFinishedTasks",function(e){var n=s("app").get("myTasks2");t.tasks.mine.list=e?n.on.concat(n.off):n.on}),t.$watch("showAllTasks",function(e){var n=s("app").get("allTasks2");e?t.tasks.all.list=n.on.concat(n.off):t.tasks.all.list=n.on});if(t.views.newTask==1){var b=S(new Date,15),w=S(new Date,30);t.task||(t.task={},t.task.start={},t.task.end={}),t.task.start={date:new Date,time:b},t.task.end={date:new Date,time:w}}t.newTime=function(e){t.task.end.time=S(e,15)},t.newDate=function(e){t.task.end.date=e},t.openTask=function(n){t.task=n,t.task.team=n.assignedTeamUuid,n.assignedTeamUuid&&(n.assignedTeamFullName=e.getTeamName(n.assignedTeamUuid)),n.relatedClient.clientGroupUuid&&(n.relatedClient.clientGroupName=e.getClientGroupName(n.relatedClient.clientGroupUuid));var r=e.getTeamMemberById(n.authorUuid);t.author=r.firstName+" "+r.lastName,angular.element("#taskModal").modal("show")},t.orderBy=function(e){t.ordered=e,t.reversed=!t.reversed},t.assignTask=function(t){trackGa("send","event","Task-assign",e.app.resources.uuid,t.uuid),t.assignedTeamMemberUuid=e.app.resources.uuid,x(t,!0),m("myTasks")},t.unAssignTask=function(t){trackGa("send","event","Task-unassign",e.app.resources.uuid,t.uuid),t.assignedTeamMemberUuid=null,t.assignedTeamUuid=null,x(t)},t._task={},t.confirmDeleteTask=function(e){r(function(){t._task=e,angular.element("#confirmTaskModal").modal("show")})},t.deleteTask=function(n){t._task={},angular.element("#confirmTaskModal").modal("hide"),o._("taskDelete",{second:n.uuid},n).then(function(t){t.error?t.error.data?e.notifier.error(t.error.data):e.notifier.error(t.error):(e.notifier.success(e.ui.task.taskDeleted),g())})},t.members=h.members[t.currentTeam],t.groups=[],t.clients=[],t.teamAffectGroup=function(){t.groups=[],angular.forEach(p.clientGroups,function(e){t.currentGroup==e.id&&t.groups.push(e)}),t.groupAffectClient(t.currentGroup)},t.groupAffectClient=function(e){t.clients=p.clients[e],(t.currentClient==null||typeof t.currentClient=="undefined")&&t.clients&&t.clients.length>0?t.currentClient=t.clients[0].uuid:t.currentClient=null,t.task&&t.task.client&&(t.task.client=t.currentClient)},typeof d[t.currentTeam]=="undefined"?t.currentGroup=null:(t.currentGroup=d[t.currentTeam],t.teamAffectGroup(),t.groupAffectClient(t.currentGroup)),t.changeClientGroup=function(e){t.groupAffectClient(e)},t.changeTeam=function(e){t.members=h.members[e],t.currentGroup=d[e],t.teamAffectGroup()},t.changeTeam(t.currentTeam),u.chains(),t.validateTaskForm=function(n){if(!n||!n.start||!n.end)return e.notifier.error(e.ui.task.filltheTime),!1;if(n.start.date==""||n.start.time==""||!n.start.time)return e.notifier.error(e.ui.task.startTimeEmpty),!1;if(n.end.date==""||n.end.time==""||!n.end.time)return e.notifier.error(e.ui.task.endTimeEmpty),!1;if(!t.taskForm.$valid){e.notifier.error(e.ui.task.taskFormValide);return}return t.task.startTime=e.browser.mobile?(new Date(n.start.date)).getTime():l.convert.absolute(E(n.start.date,"dd-MM-yyyy"),E(n.start.time,"HH:mm"),!1),t.task.endTime=e.browser.mobile?(new Date(n.end.date)).getTime():l.convert.absolute(E(n.end.date,"dd-MM-yyyy"),E(n.end.time,"HH:mm"),!1),t.task.startTime<=Date.now().getTime()||t.task.endTime<=Date.now().getTime()?(e.notifier.error(e.ui.task.planTaskInFuture),!1):t.task.startTime>=t.task.endTime?(e.notifier.error(e.ui.task.startLaterThanEnd),!1):!n.client||n.client==null?(e.notifier.error(e.ui.task.specifyClient),!1):!0},t.saveTask=function(e){if(!t.validateTaskForm(e))return;var n={uuid:e.uuid?e.uuid:"",status:2,plannedStartVisitTime:t.task.startTime,plannedEndVisitTime:t.task.endTime,relatedClientUuid:e.client,assignedTeamUuid:e.team,description:e.description,assignedTeamMemberUuid:e.member};_.isEmpty(e.uuid)?T(n):N(n)};var T=function(t){e.statusBar.display(e.ui.task.creatingTask),o._("taskAdd",null,t).then(function(e){C(e,t)})},N=function(t){e.statusBar.display(e.ui.task.editingTask),u.update(t).then(function(e){C(e,t)})},C=function(t,n){t.error?(t.error.data?e.notifier.error(e.transError(t.error.data.result)):e.notifier.error(e.transError(t.error)),e.statusBar.off()):(n.assignedTeamMemberUuid==e.app.resources.uuid?g(!0,function(){m("myTasks"),e.notifier.success(e.ui.task.taskSaved)}):y(function(){m("allTasks"),e.notifier.success(e.ui.task.taskSaved)}),e.statusBar.off())}}])});