define(["controllers/controllers"],function(e){function s(e){e.stopPropagation(),e.preventDefault();var t=e.dataTransfer.files;u(t)}function o(e){var t=e.target.files;u(t)}function u(e){t=document.getElementsByName("userabs")[0].checked,n=!1;var r,i;for(r=0,i=e[r];r!=e.length;++r){var s=new FileReader,o=i.name;s.onload=function(e){typeof console!="undefined"&&console.log("onload",new Date,t,n);var r=e.target.result;if(n)d(r,S);else{var i;if(t)i=XLSX.read(r,{type:"binary"});else{var s=f(r);i=XLSX.read(btoa(s),{type:"base64"})}S(i)}},t?s.readAsBinaryString(i):s.readAsArrayBuffer(i),$("#UploadStepSelectFile").hide(),E("Verwerken","file")}}function a(e){e.stopPropagation(),e.preventDefault(),e.dataTransfer.dropEffect="copy"}function f(e){var t="",n=0,r=10240;for(;n<e.byteLength/r;++n)t+=String.fromCharCode.apply(null,new Uint8Array(e.slice(n*r,n*r+r)));return t+=String.fromCharCode.apply(null,new Uint8Array(e.slice(n*r))),t}function l(e){var t="",n=0,r=10240;for(;n<e.byteLength/r;++n)t+=String.fromCharCode.apply(null,new Uint16Array(e.slice(n*r,n*r+r)));return t+=String.fromCharCode.apply(null,new Uint16Array(e.slice(n*r))),t}function c(e){var t=new ArrayBuffer(e.length*2),n=new Uint16Array(t);for(var r=0;r!=e.length;++r)n[r]=e.charCodeAt(r);return[n,t]}function h(e,n){var r=new Worker("./xlsxworker.js");r.onmessage=function(e){switch(e.data.t){case"ready":break;case"e":console.error(e.data.d);break;case"xlsx":n(JSON.parse(e.data.d))}};var i=t?e:btoa(f(e));r.postMessage({d:i,b:t})}function p(e,n){var r=new Worker(t?"./xlsxworker2.js":"./xlsxworker1.js");r.onmessage=function(e){var t;switch(e.data.t){case"ready":break;case"e":console.error(e.data.d);break;default:t=l(e.data).replace(/\n/g,"\\n").replace(/\r/g,"\\r"),console.log("done"),n(JSON.parse(t))}};if(t){var i=c(e);r.postMessage(i[1],[i[1]])}else r.postMessage(e,[e])}function d(e,t){r=document.getElementsByName("xferable")[0].checked,r?p(e,t):h(e,t)}function v(e){var t=document.getElementsByName(e);for(var n=0;n<t.length;n++)if(t[n].checked||t.length===1)return t[n].value}function m(e){var t={};return e.SheetNames.forEach(function(n){var r=XLSX.utils.sheet_to_row_object_array(e.Sheets[n]);r.length>0&&(t[n]=r)}),t}function g(e){var t=[];return e.SheetNames.forEach(function(n){var r=XLSX.utils.sheet_to_csv(e.Sheets[n]);r.length>0&&(t.push("SHEET: "+n),t.push(""),t.push(r))}),t.join("\n")}function y(e){var t=[];return e.SheetNames.forEach(function(n){var r=XLSX.utils.get_formulae(e.Sheets[n]);r.length>0&&(t.push("SHEET: "+n),t.push(""))}),t.join("\n")}function w(){typeof console!="undefined"&&console.log("onload",new Date);var e=XLSX.read(b.value,{type:"base64",WTF:i});S(e)}function E(e,t){var n=$("#breadcrumb"),r="#/upload";t&&(r="#/upload#"+t);var i=n.contents().last().wrap('<a href="'+r+'">');n.append(e)}function S(e){E("Week kiezen");var t=$("#UploadStepSelectSheet");t.show();var n;for(n in e.Sheets)$("<div class='SheetDiv'>").append(n).appendTo(t).click(n,function(t){var n=new P(e.Sheets[t.data]);n.matchTeamMembers(),n.matchClients(),x(n)})}function x(e){$("#UploadStepSelectSheet").hide(),E("Routes controleren"),C(e),$("#UploadStepCheckStructure").show(),$("#checkStructureProceed").on("click",e,T)}function T(e){var t=e.data;$("#UploadStepCheckStructure").hide(),E("Namen controleren"),N(t.matchedTeamMemberForName,"#UploadStepCheckTeamMemberNames"),N(t.matchedClientForName,"#UploadStepCheckClientNames"),$("#UploadStepCheckNames").show()}function N(e,t){var n=[];for(var r in e){var i=e[r];i.originalName=r,n.push(i)}n.sort(function(e,t){return e.score-t.score});for(var s=0;s<n.length;s++){var i=n[s],o=$("<select>"),u=i.alternatives;for(var a=0;a<u.length;a++){var f=u[a],l=(f.score*100).toFixed(),c=$("<option>"+f.person.firstName+" "+f.person.lastName+" ("+l+"%)</option>");i.person===f.person&&c.prop("selected",!0),c.appendTo(o)}var h=o.wrap($("<span>")),p=$("<div><label>"+i.originalName+"</label></div>").appendTo($(t+" form fieldset"));p.append(h)}}function C(e){try{var t=require("moment");t.lang("nl");for(var n=0;n<e.errors.length;n++)$("#UploadStepShowErrors").append("<p>Foutcode "+e.errors[n].code+": <span>"+e.errors[n].text+"</span></p>");var r=null,i;for(var s=0;s<e.routes.length;s++){var o=e.routes[s];if(r===null||r!=o.startDate)r=o.startDate,i=$("<div class='SheetDayDiv'></div>").appendTo($("#UploadStepShowRoutes")),$("<h3>"+t(r).format("dddd")+"</h3>").appendTo(i),$("<div class='SheetDayDateDiv'>"+t(r).format("LL")+"</div>").appendTo(i);var u=$("<div class='SheetRouteDiv'><h4>"+o.name+"</h4></div>").appendTo(i),a=o.teamMemberName;if(a==null)a="<span style='color:red'>niemand</span>";else if(o.teamMember==null)a=o.teamMemberName;else{var f=(o.teamMemberScore*100).toFixed();a=o.teamMember.firstName+" ("+f+"% "+a+")"}var l="Teamlid: "+a;$("<span>"+l+"</span>").appendTo(u);var c=e.routes[s].tasks;for(var h=0;h<c.length;h++){var p=c[h],d=$("<div class='SheetTaskDiv'>").appendTo(u),t=require("moment"),v=t(p.startTime).format("HH:mm");d.append("<div class='SheetTaskStartDiv'>"+v+"</div>");var m=p.clientName;if(m==null)m="niemand";else if(p.client!=null){var f=(p.clientScore*100).toFixed();m=p.client.firstName+" "+p.client.lastName+" ("+f+"%)"}d.append("<div class='SheetTaskClientDiv'>"+m+"</div>"),d.append("<div class='SheetTaskDurationDiv'>"+p.duration+"</div>")}}}catch(g){console.log(g),console.log(g.stack)}}function k(e,t){this.startTime=e,this.endTime=t}function L(e){try{if(e.t=="n"&&typeof e.v=="number"&&typeof e.w=="string"&&e.v>0&&e.v<2958465){var t=XLSX.SSF.parse_date_code(e.v,{date1904:!1},!1);return new Date(t.y,t.m-1,t.d)}return null}catch(n){return console.log("getDateFromCell(): Cell ("+typeof e+") is "+e),null}}function A(e,t){var n=XLSX.utils.encode_cell({c:e,r:t});return n}function O(e,t,n){var r=A(t,n),i=e[r];return i}function M(e){var t=null;return e.v?t=e.v.trim():console.log("Trying to read wrong value"),t}function _(e,t){var n=/([0-9]{1,2})[^0-9]{1}([0-9]{1,2})/,r=e.v.match(n);if(r===null)return null;var i=r[1],s=r[2],o=new Date(t);return o.setHours(i),o.setMinutes(s),o}function D(e){var t=null;return typeof e!="undefined"&&(e.t==="s"||e.t==="str")&&(t=e.v.trim()),t}function P(e){function t(){var e=JSON.parse(localStorage["teams.own"]).value[0].uuid,t=JSON.parse(localStorage["app.teamGroup_"+e]).value[0].id,n=JSON.parse(localStorage["app."+t]).value;for(var r=0;r<this.routes.length;r++){var i=this.routes[r];for(var s=0;s<i.tasks.length;s++){var o=i.tasks[s],u=o.clientName;if(typeof this.matchedClientForName[u]=="undefined"){var a=[],f=null,l=u.toLowerCase();for(var c in n){var h=n[c],p=h.lastName.toLowerCase(),d=clj_fuzzy.metrics.jaro_winkler(p,l);console.log("Score for "+l+" vs. "+p+": "+d);if(d>this.minimalMatchScore){var v={score:d,person:h};if(f==null||d>f.score)f=v;a.push(v)}}f!==null&&(a.sort(function(e,t){return t.score-e.score}),f.alternatives=a,this.matchedClientForName[u]=f)}}}}function n(){var e=JSON.parse(localStorage["teams.own"]).value[0].uuid,t=JSON.parse(localStorage["app."+e]).value;for(var n=0;n<this.routes.length;n++){var r=this.routes[n],i=r.teamMemberName;if(i==null)continue;if(typeof this.matchedTeamMemberForName[i]=="undefined"){var s=[],o=null,u=i.toLowerCase();for(var a in t){var f=t[a],l=f.firstName.toLowerCase(),c=clj_fuzzy.metrics.jaro_winkler(l,u);console.log("Score for "+i+" vs. "+l+": "+c);if(c>this.minimalMatchScore){var h={score:c,person:f};if(o==null||c>o.score)o=h;s.push(h)}}o!==null&&(s.sort(function(e,t){return t.score-e.score}),o.alternatives=s,this.matchedTeamMemberForName[i]=o)}}}function r(e){for(var t=0;t<this.maxRange.e.c;t++){var n=O(e,t,this.periodHeaderRow);if(typeof n=="undefined")continue;var r=L(n);r!==null&&(t<3&&(this.periodHeaderRows=this.findPeriodHeaders(e,t,this.periodHeaderRow+1)),this.periodStartColumns[t]=r)}console.log(this.periodHeaderRows);for(var t in this.periodStartColumns)for(var i in this.periodHeaderRows){var s=parseInt(i)+1;console.log("Reading next route starting at "+A(t,s));var o={startDate:this.periodStartColumns[t],teamMemberName:null,tasks:[],name:this.periodHeaderRows[i]};for(var u=s;u<this.maxRange.e.r;u++){if(typeof this.periodHeaderRows[u]!="undefined")break;if(o.teamMemberName===null&&u===s)for(var a=-1;a<=1;a++){var f=parseInt(t)+a,n=O(e,f,u),l=D(n);l!==null&&l.length>0&&(o.teamMemberName=l)}else{var c={startTime:null,clientName:null,duration:0};for(var a=-1;a<=1;a++){var f=parseInt(t)+a,h=A(f,u),n=e[h];if(typeof n=="undefined")break;switch(n.t){case"b":a==-1?this.errors.push({code:1001,text:"Er is een ja/nee waarde gevonden in cell "+h+", terwijl er een tijdstip werd verwacht."}):a==0?this.errors.push({code:1002,text:"Er is een ja/nee waarde gevonden in cell "+h+", terwijl er een clientnaam werd verwacht."}):a==1&&this.errors.push({code:1003,text:"Er is een ja/nee waarde gevonden in cell "+h+", terwijl er een aantal minuten werd verwacht."});break;case"n":a==-1?this.errors.push({code:1004,text:"Er is een getal gevonden in cell "+h+", terwijl er een tijdstip werd verwacht."}):a==0?this.errors.push({code:1005,text:"Er is een getal gevonden in cell "+h+", terwijl er een clientnaam werd verwacht."}):a==1&&(c.duration=parseInt(n.v));break;case"e":this.errors.push({code:1006,text:"Er is een fout gevonden in cell "+h+": "+n.v});break;case"s":case"str":if(a==-1){var p=_(n,o.startDate);p===null?(this.errors.push({code:1007,text:"Het is niet mogelijk om het tijdstip in cell "+h+" te lezen."}),c=null):c.startTime=p}else a==0?c.clientName=D(n):a==1&&(c.duration=parseInt(n.v))}if(c===null)break}c!==null&&c.startTime!==null&&c.clientName!==null&&o.tasks.push(c)}}o.teamMemberName===null&&o.tasks.length>0&&this.nofUnassignedRoutes++,this.routes.push(o)}this.nofUnassignedRoutes>0&&this.errors.push({code:1009,text:"Er zijn "+this.nofUnassignedRoutes+" routes waaraan nog geen teamlid is toegekend."})}function i(e,t,n){var r={},i=null;for(var s=n;s<this.maxRange.e.r;s++)for(var o=-1;o<=1;o++)try{var u=t+o,a=O(e,u,s);if(typeof a=="undefined")continue;var f=D(a);if(f===null||f.length==0)continue;f=f.toLowerCase();if(f.indexOf("fbpz")>=0)break;if(this.dayparts.indexOf(f)>=0){console.log("Found a daypart: "+f),i=f;var l=!1,c=O(e,u,s+1);if(c){var h=D(c);h!==null&&(h=h.toLowerCase(),h.indexOf("route")>=0&&(l=!0))}if(l===!1){var p=i;r[s]=p}break}if(f.indexOf("route")==0){if(i===null)throw"Found a route without having a daypart.";var p=i+" "+f;r[s]=p;break}}catch(d){return this.errors.push({code:1008,text:"Er is een onbekende fout opgetreden: "+d}),console.log(d),console.log(d.stack),r}return r}if(e==null||e["!ref"]==null)return"";this.nofColumnsPerPeriod=3,this.firstPeriodColumn=0,this.periodHeaderRow=1,this.minimalMatchScore=.1,this.maxRange=XLSX.utils.decode_range(e["!ref"]),this.dayparts=["ochtend","namiddag","avond","middag","nacht"],this.periodHeaderRows={},this.periodStartColumns={},this.teamMemberNames=[],this.routes=[],this.errors=[],this.matchedTeamMemberForName={},this.matchedClientForName={},this.nofUnassignedRoutes=0,this.matchClients=t,this.matchTeamMembers=n,this.parseSheet=r,this.findPeriodHeaders=i,this.parseSheet(e)}var t=typeof FileReader!="undefined"&&typeof FileReader.prototype!="undefined"&&typeof FileReader.prototype.readAsBinaryString!="undefined";t||(document.getElementsByName("userabs")[0].disabled=!0,document.getElementsByName("userabs")[0].checked=!1);var n=typeof Worker!="undefined";n||(document.getElementsByName("useworker")[0].disabled=!0,document.getElementsByName("useworker")[0].checked=!1);var r=n;r||(document.getElementsByName("xferable")[0].disabled=!0,document.getElementsByName("xferable")[0].checked=!1);var i=!1;setTimeout(function(){var e=document.getElementById("xlf");e.addEventListener&&e.addEventListener("change",o,!1)},1500);var b=document.getElementById("b64data");e.controller("uploadCtrl",["$rootScope","$scope","$location","Clients","$route","$routeParams","Store","Dater","$filter","$modal","TeamUp","$timeout",function(e,t,n,r,i,s,o,u,a,f,l,c){console.log("Clients -> ",r)}])});