define(["controllers/controllers"],function(e){e.controller("uploadCtrl",["$rootScope","$scope","$q","$location","Clients","Task","$route","$routeParams","Store","Dater","$filter","$modal","TeamUp","$timeout",function(e,t,n,r,i,s,o,u,a,f,l,c,h,p){function w(e){m=document.getElementsByName("userabs")[0].checked,g=!1;var n,r;for(n=0,r=e[n];n!=e.length;++n){var i=new FileReader,s=r.name;i.onload=function(e){typeof console!="undefined"&&console.log("onload",new Date,m,g);var n=e.target.result;if(g)k(n,D);else{var r;if(m)r=XLSX.read(n,{type:"binary"});else{var i=S(n);r=XLSX.read(btoa(i),{type:"base64"})}D(r),t.$apply()}},m?i.readAsBinaryString(r):i.readAsArrayBuffer(r),t.step="ProcessFile",M("Bestand verwerken","file"),t.$apply()}}function E(e){e.stopPropagation(),e.preventDefault(),e.dataTransfer.dropEffect="copy"}function S(e){var t="",n=0,r=10240;for(;n<e.byteLength/r;++n)t+=String.fromCharCode.apply(null,new Uint8Array(e.slice(n*r,n*r+r)));return t+=String.fromCharCode.apply(null,new Uint8Array(e.slice(n*r))),t}function x(e){var t="",n=0,r=10240;for(;n<e.byteLength/r;++n)t+=String.fromCharCode.apply(null,new Uint16Array(e.slice(n*r,n*r+r)));return t+=String.fromCharCode.apply(null,new Uint16Array(e.slice(n*r))),t}function T(e){var t=new ArrayBuffer(e.length*2),n=new Uint16Array(t);for(var r=0;r!=e.length;++r)n[r]=e.charCodeAt(r);return[n,t]}function N(e,t){var n=new Worker("./xlsxworker.js");n.onmessage=function(e){switch(e.data.t){case"ready":break;case"e":console.error(e.data.d);break;case"xlsx":t(JSON.parse(e.data.d))}};var r=m?e:btoa(S(e));n.postMessage({d:r,b:m})}function C(e,t){var n=new Worker(m?"./xlsxworker2.js":"./xlsxworker1.js");n.onmessage=function(e){var n;switch(e.data.t){case"ready":break;case"e":console.error(e.data.d);break;default:n=x(e.data).replace(/\n/g,"\\n").replace(/\r/g,"\\r"),console.log("done"),t(JSON.parse(n))}};if(m){var r=T(e);n.postMessage(r[1],[r[1]])}else n.postMessage(e,[e])}function k(e,t){y=document.getElementsByName("xferable")[0].checked,y?C(e,t):N(e,t)}function L(e){var t=document.getElementsByName(e);for(var n=0;n<t.length;n++)if(t[n].checked||t.length===1)return t[n].value}function O(){typeof console!="undefined"&&console.log("onload",new Date);var e=XLSX.read(A.value,{type:"base64",WTF:b});D(e)}function M(e,t){var n=$("#breadcrumb"),r="#/upload";t&&(r="#/upload#"+t);var i=n.contents().last().wrap('<a href="'+r+'">');n.append(e)}function D(e){M("Week kiezen","chooseWeek"),t.step="SelectSheet",t.sheetNames=Object.keys(e.Sheets),t.workbook=e}function P(e){var t=[];for(var n in e){var r=e[n];r.originalName=n,t.push(r)}return t.sort(function(e,t){return e.score-t.score}),t}function H(e){try{var t=null,n}catch(r){console.log(r),console.log(r.stack)}}function B(e){try{if(e.t=="n"&&typeof e.v=="number"&&typeof e.w=="string"&&e.v>0&&e.v<2958465){var n=XLSX.SSF.parse_date_code(e.v,{date1904:t.workbook.Workbook.WBProps.date1904=="1"},!1);return new Date(n.y,n.m-1,n.d)}return null}catch(r){return console.log("getDateFromCell(): Cell ("+typeof e+") is "+e),null}}function j(e,t){var n=XLSX.utils.encode_cell({c:e,r:t});return n}function F(e,t,n){var r=j(t,n),i=e[r];return i}function I(e){var t=null;return e.v?t=e.v.trim():console.log("Trying to read wrong value"),t}function q(e,t){var n=/([0-9]{1,2})[^0-9]{1}([0-9]{1,2})/,r=e.v.match(n);if(r===null)return null;var i=r[1],s=r[2],o=new Date(t);return o.setHours(i),o.setMinutes(s),o}function R(e){var t=null;return typeof e!="undefined"&&(e.t==="s"||e.t==="str")&&(t=e.v.trim()),t}function U(r){function i(e){e.map(function(e){return h._("taskAdd",null,e.backendTask).then(function(n){n.error?(console.log("error for "+e.clientName),t.taskCreateErrors.push(e),e.uploadStatus="failed"):(console.log("success for "+e.clientName),e.uploadStatus="success")})})}function o(e){var t=[];return angular.forEach(e,function(e){t.push(h._("taskDelete",{second:e.uuid},e).then(function(t){return t.error&&console.log("failed ",e),t}))}),n.all(t)}function u(e){for(var t=0;t<this.maxRange.e.c;t++){var n=F(e,t,this.periodHeaderRow);if(typeof n=="undefined")continue;var r=B(n);r!==null&&(t<3&&(this.periodHeaderRows=this.findPeriodHeaders(e,t,this.periodHeaderRow+1)),this.days.push({col:t,startDate:r,routes:[]}))}console.log(this.periodHeaderRows);for(var i=0;i<this.days.length;i++){var s=this.days[i],t=s.col;for(var o in this.periodHeaderRows){var u=parseInt(o)+1,a={startDate:s.startDate,teamMemberName:null,tasks:[],name:this.periodHeaderRows[o],doInsert:!1};for(var f=u;f<this.maxRange.e.r;f++){if(typeof this.periodHeaderRows[f]!="undefined")break;if(a.teamMemberName===null&&f===u)for(var l=-1;l<=1;l++){var c=parseInt(t)+l,n=F(e,c,f),h=R(n);h!==null&&h.length>0&&(a.teamMemberName=h)}else{var p={backendTask:{uuid:"",status:2,plannedStartVisitTime:null,plannedEndVisitTime:null,assignedTeamUuid:this.myTeamUuid,description:"Geimporteerd vanuit een spreadsheet"},clientName:null,duration:0,route:a,doInsert:!1,uploadStatus:"open"};for(var l=-1;l<=1;l++){var c=parseInt(t)+l,d=j(c,f),n=e[d];if(typeof n=="undefined")break;switch(n.t){case"b":l==-1?this.errors.push({code:1001,text:"Er is een ja/nee waarde gevonden in cell "+d+", terwijl er een tijdstip werd verwacht."}):l==0?this.errors.push({code:1002,text:"Er is een ja/nee waarde gevonden in cell "+d+", terwijl er een clientnaam werd verwacht."}):l==1&&this.errors.push({code:1003,text:"Er is een ja/nee waarde gevonden in cell "+d+", terwijl er een aantal minuten werd verwacht."});break;case"n":l==-1?this.errors.push({code:1004,text:"Er is een getal gevonden in cell "+d+", terwijl er een tijdstip werd verwacht."}):l==0?this.errors.push({code:1005,text:"Er is een getal gevonden in cell "+d+", terwijl er een clientnaam werd verwacht."}):l==1&&(p.duration=parseInt(n.v));break;case"e":this.errors.push({code:1006,text:"Er is een fout gevonden in cell "+d+": "+n.v});break;case"s":case"str":if(l==-1){var v=q(n,a.startDate);v===null?(this.errors.push({code:1007,text:"Het is niet mogelijk om het tijdstip in cell "+d+" te lezen."}),p=null):p.backendTask.plannedStartVisitTime=v}else l==0?p.clientName=R(n):l==1&&(p.duration=parseInt(n.v))}if(p===null)break}var m=p.backendTask;p!==null&&m.plannedStartVisitTime!==null&&p.clientName!==null&&(p.duration>0&&(p.doInsert=!0),a.tasks.push(p))}}a.tasks.length>0&&(a.teamMemberName===null?this.nofUnassignedRoutes++:a.doInsert=!0),this.routes.push(a),s.routes.push(a)}}this.nofUnassignedRoutes>0&&this.errors.push({code:1009,text:"Er zijn "+this.nofUnassignedRoutes+" routes waaraan nog geen teamlid is toegekend."})}function f(e,t,n){var r={},i=null;for(var s=n;s<this.maxRange.e.r;s++)for(var o=-1;o<=1;o++)try{var u=t+o,a=F(e,u,s);if(typeof a=="undefined")continue;var f=R(a);if(f===null||f.length==0)continue;f=f.toLowerCase();if(f.indexOf("fbpz")>=0)break;if(this.dayparts.indexOf(f)>=0){console.log("Found a daypart: "+f),i=f;var l=!1,c=F(e,u,s+1);if(c){var h=R(c);h!==null&&(h=h.toLowerCase(),h.indexOf("route")>=0&&(l=!0))}if(l===!1){var p=i;r[s]=p}break}if(f.indexOf("route")==0){if(i===null)throw"Found a route without having a daypart.";var p=i+" "+f;r[s]=p;break}}catch(d){return this.errors.push({code:1008,text:"Er is een onbekende fout opgetreden: "+d}),console.log(d),console.log(d.stack),r}return r}if(r==null||r["!ref"]==null)return"";this.myTeamUuid=d[0],this.myTeamClientGroupId=a("app").get("teamGroup_"+this.myTeamUuid),this.nofColumnsPerPeriod=3,this.firstPeriodColumn=0,this.periodHeaderRow=1,this.minimalMatchScore=.1,this.maxRange=XLSX.utils.decode_range(r["!ref"]),this.dayparts=["ochtend","namiddag","avond","middag","nacht"],this.periodHeaderRows={},this.days=[],this.teamMemberNames=[],this.routes=[],this.errors=[],this.matchedTeamMemberForName={},this.matchedClientForName={},this.nofUnassignedRoutes=0,this.nofMatches=0,this.confirmedTeamMemberForName={},this.confirmedClientForName={},this.uploadTasks=function(){var e=[];for(var t=0;t<this.routes.length;t++){var r=this.routes[t];if(!r.doInsert)continue;var s=r.teamMemberName;if(s){r.teamMember=this.matchedTeamMemberForName[s].person;var o=r.teamMember.uuid;for(var u=0;u<r.tasks.length;u++){var a=r.tasks[u];if(!a.doInsert)continue;var f=a.clientName;a.client=this.matchedClientForName[f].person;var l=a.client.uuid,c=a.backendTask;c.plannedStartVisitTime=c.plannedStartVisitTime.getTime(),c.plannedEndVisitTime=c.plannedStartVisitTime+a.duration*60*1e3,a.duration>0&&(c.plannedEndVisitTime-=1e3),c.relatedClientUuid=l,c.assignedTeamMemberUuid=o,e.push(a)}}}v=e;var h=i(e);return n.all(h)},t.deleteWeek=function(){var e=moment(t.tuSheet.days[0].startDate);s.getWeek(d[0],e.week(),moment().get("year")).then(function(e){o(e).then(function(e){console.log("Deze taken zijn verwijdered ",e)})})},this.addConfirmedClient=function(e,t){this.confirmedClientForName[e]=t},this.addConfirmedTeamMember=function(e,t){this.confirmedTeamMemberForName[e]=t},this.matchClients=function(){var n=e.getClientsByTeam(d);for(var r=0;r<this.routes.length;r++){var i=this.routes[r];if(i.doInsert===!1)continue;for(var s=0;s<i.tasks.length;s++){var o=i.tasks[s];if(!o.doInsert)continue;var u=o.clientName;if(typeof this.matchedClientForName[u]=="undefined"){var a=[],f=null,l=u.toLowerCase();for(var c in n){var h=n[c],p=h.firstName.toLowerCase()+" "+h.lastName.toLowerCase(),p=h.lastName.toLowerCase(),v=clj_fuzzy.metrics.jaro_winkler(p,l);if(v>this.minimalMatchScore){var m={score:v,person:h,task:o,matchId:this.nofMatches++};if(f==null||v>f.score)f=m;a.push(m)}}f!==null&&(a.sort(function(e,t){return t.score-e.score}),f.alternatives=a,this.matchedClientForName[u]=f)}}}},this.matchTeamMembers=function(){var t=a("app").get(d[0]);console.log(t),angular.forEach(t,function(e){e.fullName="",e.firstName&&(e.fullName+=e.firstName),e.firstName&&e.lastName&&(e.fullName+=" "),e.lastName&&(e.fullName+=e.lastName)});for(var n=0;n<this.routes.length;n++){var r=this.routes[n],i=r.teamMemberName;if(r.doInsert===!1)continue;if(i==null)continue;if(typeof this.matchedTeamMemberForName[i]=="undefined"){var s=[],o=null,u=i.toLowerCase();for(var f in t){var l=t[f],c=l.firstName.toLowerCase(),h=clj_fuzzy.metrics.jaro_winkler(c,u);if(h>this.minimalMatchScore){var p={score:h,person:l,route:r,matchId:this.nofMatches++};if(o==null||h>o.score)o=p;s.push(p)}}o!==null&&(s.sort(function(e,t){return t.score-e.score}),o.alternatives=s,this.matchedTeamMemberForName[i]=o)}}},this.parseSheet=u,t.toggleRouteInsert=function(){for(var e=0;e<this.route.tasks.length;e++)this.route.tasks[e].doInsert=this.route.doInsert},this.findPeriodHeaders=f,this.parseSheet(r)}t.step="SelectFile",t.workbook={},t.tuSheet={},t.matchedTeamMembersByName={},t.matchedClientsByName={},t.taskCreateErrors=[];var d=_.pluck(e.app.resources.teamUuids,"uuid"),v=[];t.handleFile=function(e){w(e)},t.handleDragover=function(e){e.stopPropagation(),e.preventDefault(),e.dataTransfer.dropEffect="copy"},t.handleDragenter=function(e){e.stopPropagation(),e.preventDefault(),e.dataTransfer.dropEffect="copy"},t.handleDrop=function(e){e.stopPropagation(),e.preventDefault();var t=e.dataTransfer.files;w(t)};var m=typeof FileReader!="undefined"&&typeof FileReader.prototype!="undefined"&&typeof FileReader.prototype.readAsBinaryString!="undefined";m||(document.getElementsByName("userabs")[0].disabled=!0,document.getElementsByName("userabs")[0].checked=!1);var g=typeof Worker!="undefined";g||(document.getElementsByName("useworker")[0].disabled=!0,document.getElementsByName("useworker")[0].checked=!1);var y=g;y||(document.getElementsByName("xferable")[0].disabled=!0,document.getElementsByName("xferable")[0].checked=!1);var b=!1,A=document.getElementById("b64data");t.selectSheet=function(e){function r(){var r=n.defer();return setTimeout(function(){console.log("Start analysing sheet data"),t.tuSheet=new U(t.workbook.Sheets[e]),r.resolve()},100),r.promise}t.step="ProcessSheet",M("Sheet verwerken","processSheet"),n.when(r()).then(function(){console.log(t.tuSheet.days[0]),t.uploadStepCheckStructure()})},t.uploadStepCheckStructure=function(){t.step="CheckStructure",M("Routes controleren","checkRoutes")},t.uploadStepCheckNames=function(){t.step="CheckNames",M("Namen controleren","checkNames"),t.tuSheet.matchTeamMembers(),t.tuSheet.matchClients(),t.matchedTeamMembersByName=P(t.tuSheet.matchedTeamMemberForName),t.matchedClientsByName=P(t.tuSheet.matchedClientForName)},t.textForTaskUploadStatus=function(e){var t={failed:"mislukt",open:"open",busy:"bezig",success:"gelukt"};return t[e]},t.uploadStepConfirmNames=function(){t.step="CreateTasks",M("Taken aanmaken","createTasks"),t.tuSheet.uploadTasks()}}])});