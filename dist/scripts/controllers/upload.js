define(["controllers/controllers"],function(e){function s(e){e.stopPropagation(),e.preventDefault();var t=e.dataTransfer.files;u(t)}function o(e){var t=e.target.files;u(t)}function u(e){t=document.getElementsByName("userabs")[0].checked,n=!1;var r,i;for(r=0,i=e[r];r!=e.length;++r){var s=new FileReader,o=i.name;s.onload=function(e){typeof console!="undefined"&&console.log("onload",new Date,t,n);var r=e.target.result;if(n)d(r,S);else{var i;if(t)i=XLSX.read(r,{type:"binary"});else{var s=f(r);i=XLSX.read(btoa(s),{type:"base64"})}S(i)}},t?s.readAsBinaryString(i):s.readAsArrayBuffer(i),$("#UploadStepSelectFile").hide(),E("Verwerken")}}function a(e){e.stopPropagation(),e.preventDefault(),e.dataTransfer.dropEffect="copy"}function f(e){var t="",n=0,r=10240;for(;n<e.byteLength/r;++n)t+=String.fromCharCode.apply(null,new Uint8Array(e.slice(n*r,n*r+r)));return t+=String.fromCharCode.apply(null,new Uint8Array(e.slice(n*r))),t}function l(e){var t="",n=0,r=10240;for(;n<e.byteLength/r;++n)t+=String.fromCharCode.apply(null,new Uint16Array(e.slice(n*r,n*r+r)));return t+=String.fromCharCode.apply(null,new Uint16Array(e.slice(n*r))),t}function c(e){var t=new ArrayBuffer(e.length*2),n=new Uint16Array(t);for(var r=0;r!=e.length;++r)n[r]=e.charCodeAt(r);return[n,t]}function h(e,n){var r=new Worker("./xlsxworker.js");r.onmessage=function(e){switch(e.data.t){case"ready":break;case"e":console.error(e.data.d);break;case"xlsx":n(JSON.parse(e.data.d))}};var i=t?e:btoa(f(e));r.postMessage({d:i,b:t})}function p(e,n){var r=new Worker(t?"./xlsxworker2.js":"./xlsxworker1.js");r.onmessage=function(e){var t;switch(e.data.t){case"ready":break;case"e":console.error(e.data.d);break;default:t=l(e.data).replace(/\n/g,"\\n").replace(/\r/g,"\\r"),console.log("done"),n(JSON.parse(t))}};if(t){var i=c(e);r.postMessage(i[1],[i[1]])}else r.postMessage(e,[e])}function d(e,t){r=document.getElementsByName("xferable")[0].checked,r?p(e,t):h(e,t)}function v(e){var t=document.getElementsByName(e);for(var n=0;n<t.length;n++)if(t[n].checked||t.length===1)return t[n].value}function m(e){var t={};return e.SheetNames.forEach(function(n){var r=XLSX.utils.sheet_to_row_object_array(e.Sheets[n]);r.length>0&&(t[n]=r)}),t}function g(e){var t=[];return e.SheetNames.forEach(function(n){var r=XLSX.utils.sheet_to_csv(e.Sheets[n]);r.length>0&&(t.push("SHEET: "+n),t.push(""),t.push(r))}),t.join("\n")}function y(e){var t=[];return e.SheetNames.forEach(function(n){var r=XLSX.utils.get_formulae(e.Sheets[n]);r.length>0&&(t.push("SHEET: "+n),t.push(""))}),t.join("\n")}function w(){typeof console!="undefined"&&console.log("onload",new Date);var e=XLSX.read(b.value,{type:"base64",WTF:i});S(e)}function E(e){var t=$("#breadcrumb"),n=t.contents().last().wrap('<a href="#">');t.append(e)}function S(e){E("Week kiezen");var t=$("#UploadStepSelectSheet");t.show();var n;for(n in e.Sheets)$("<div class='SheetDiv'>").append(n).appendTo(t).click(n,function(t){$("#UploadStepSelectSheet").hide(),E("Controleren"),x(e.Sheets[t.data]),$("#UploadStepCheckResult").show()})}function x(e){console.log(e);var t;try{t=new D(e);for(var n=0;n<t.errors.length;n++)$("#UploadStepShowErrors").append("<p>"+t.errors[n].code+": "+t.errors[n].text+"</p>");var r=null,i;for(var s=0;s<t.routes.length;s++){var o=t.routes[s];if(r===null||r!=o.startDate)r=o.startDate,i=$("<div class='SheetDayDiv'><h2>"+C(r)+"</h2></div>").appendTo($("#UploadStepShowRoutes"));var u=$("<div class='SheetRouteDiv'><h3>"+o.name+"</h3></div>").appendTo(i),a=t.routes[s].tasks;for(var f=0;f<a.length;f++){var l=a[f],c=$("<div class='SheetTaskDiv'>").appendTo(u),h=l.startTime;h===null&&console.log("Start time is null"),c.append("<div class='SheetTaskStartDiv'>"+h.getHours()+":"+h.getMinutes()+"</div>"),c.append("<div class='SheetTaskClientDiv'>"+l.clientName+"</div>"),c.append("<div class='SheetTaskDurationDiv'>"+l.duration+"</div>")}}}catch(p){console.log(p)}}function T(e,t){this.startTime=e,this.endTime=t}function C(e){var t=e.getDay();return N[t]}function k(e){try{if(e.t=="n"&&typeof e.v=="number"&&typeof e.w=="string"&&e.v>0&&e.v<2958465){var t=XLSX.SSF.parse_date_code(e.v,{date1904:!1},!1);return new Date(t.y,t.m-1,t.d)}return null}catch(n){return console.log("getDateFromCell(): Cell ("+typeof e+") is "+e),null}}function L(e,t){var n=XLSX.utils.encode_cell({c:e,r:t});return n}function A(e,t,n){var r=L(t,n),i=e[r];return i}function O(e){var t=null;return e.v?t=e.v.toLowerCase().trim():console.log("Trying to read wrong value"),t}function M(e,t){var n=/([0-9]{1,2})[^0-9]{1}([0-9]{1,2})/,r=e.v.match(n);if(r===null)return null;var i=r[1],s=r[2],o=new Date(t);return o.setHours(i),o.setMinutes(s),o}function _(e){var t=null;return typeof e!="undefined"&&(e.t==="s"||e.t==="str")&&(t=e.v.toLowerCase().trim()),t}function D(e){function t(e){for(var t=0;t<this.maxRange.e.c;t++){var n=A(e,t,this.periodHeaderRow);if(typeof n=="undefined")continue;var r=k(n);r!==null&&(t<3&&(this.periodHeaderRows=this.findPeriodHeaders(e,t,this.periodHeaderRow+1)),this.periodStartColumns[t]=r)}console.log(this.periodHeaderRows);for(var t in this.periodStartColumns)for(var i in this.periodHeaderRows){var s=parseInt(i)+1;console.log("Reading next route starting at "+L(t,s));var o={startDate:this.periodStartColumns[t],teamMemberName:null,tasks:[],name:this.periodHeaderRows[i]};for(var u=s;u<this.maxRange.e.r;u++){if(typeof this.periodHeaderRows[u]!="undefined")break;if(o.teamMemberName===null)for(var a=-1;a<=1;a++){var f=parseInt(t)+a,n=A(e,t,u),l=_(n);l!==null&&(o.teamMemberName=l)}else{var c={startTime:null,clientName:null,duration:0};for(var a=-1;a<=1;a++){var f=parseInt(t)+a,h=L(f,u),n=e[h];if(typeof n=="undefined")break;switch(n.t){case"b":a==-1?this.errors.push({code:1001,text:"Er is een ja/nee waarde gevonden in cell "+h+", terwijl er een tijdstip werd verwacht."}):a==0?this.errors.push({code:1002,text:"Er is een ja/nee waarde gevonden in cell "+h+", terwijl er een clientnaam werd verwacht."}):a==1&&this.errors.push({code:1003,text:"Er is een ja/nee waarde gevonden in cell "+h+", terwijl er een aantal minuten werd verwacht."});break;case"n":a==-1?this.errors.push({code:1004,text:"Er is een getal gevonden in cell "+h+", terwijl er een tijdstip werd verwacht."}):a==0?this.errors.push({code:1005,text:"Er is een getal gevonden in cell "+h+", terwijl er een clientnaam werd verwacht."}):a==1&&(c.duration=parseInt(n.v));break;case"e":this.errors.push({code:1006,text:"Er is een fout gevonden in cell "+h+": "+n.v});break;case"s":case"str":if(a==-1){var p=M(n,o.startDate);p===null?(this.errors.push({code:1007,text:"Het is niet mogelijk om het tijdstip in cell "+h+" te lezen."}),c=null):c.startTime=p}else a==0?c.clientName=_(n):a==1&&(c.duration=parseInt(n.v))}if(c===null)break}c!==null&&c.startTime!==null&&c.clientName!==null&&o.tasks.push(c)}}this.routes.push(o)}}function n(e,t,n){var r={},i=null;for(var s=n;s<this.maxRange.e.r;s++)for(var o=-1;o<=1;o++)try{var u=t+o,a=A(e,u,s);if(typeof a=="undefined")continue;var f=_(a);if(f===null||f.length==0)continue;if(f.indexOf("fbpz")>=0)break;if(this.dayparts.indexOf(f)>=0){console.log("Found a daypart: "+f),i=f;var l=!1,c=A(e,u,s+1);if(c){var h=_(c);h!==null&&h.indexOf("route")>=0&&(l=!0)}if(l===!1){var p=i;r[s]=p}break}if(f.indexOf("route")==0){if(i===null)throw"Found a route without having a daypart.";var p=i+" "+f;r[s]=p;break}}catch(d){return console.log(d),console.log(d.stack),r}return r}if(e==null||e["!ref"]==null)return"";this.nofColumnsPerPeriod=3,this.firstPeriodColumn=0,this.periodHeaderRow=1,this.maxRange=XLSX.utils.decode_range(e["!ref"]),this.dayparts=["ochtend","namiddag","avond","middag","nacht"],this.periodHeaderRows={},this.periodStartColumns={},this.teamMemberNames=[],this.routes=[],this.errors=[],this.parseSheet=t,this.findPeriodHeaders=n,this.parseSheet(e)}var t=typeof FileReader!="undefined"&&typeof FileReader.prototype!="undefined"&&typeof FileReader.prototype.readAsBinaryString!="undefined";t||(document.getElementsByName("userabs")[0].disabled=!0,document.getElementsByName("userabs")[0].checked=!1);var n=typeof Worker!="undefined";n||(document.getElementsByName("useworker")[0].disabled=!0,document.getElementsByName("useworker")[0].checked=!1);var r=n;r||(document.getElementsByName("xferable")[0].disabled=!0,document.getElementsByName("xferable")[0].checked=!1);var i=!1;setTimeout(function(){var e=document.getElementById("xlf");e.addEventListener&&e.addEventListener("change",o,!1)},500);var b=document.getElementById("b64data"),N=["Zondag","Maandag","Dinsdag","Woensdag","Donderdag","Vrijdag","Zaterdag","Zondag"];e.controller("uploadCtrl",["$rootScope","$scope","$location","Clients","$route","$routeParams","Store","Dater","$filter","$modal","TeamUp","$timeout",function(e,t,n,r,i,s,o,u,a,f,l,c){console.log("Clients -> ",r)}])});