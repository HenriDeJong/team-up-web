define(["controllers/controllers"],function(e){e.controller("uploadCtrl",["$rootScope","$scope","$q","$location","Clients","$route","$routeParams","Store","Dater","$filter","$modal","TeamUp","$timeout",function(e,t,n,r,i,s,o,u,a,f,l,c,h){function g(e){p=document.getElementsByName("userabs")[0].checked,d=!1;var n,r;for(n=0,r=e[n];n!=e.length;++n){var i=new FileReader,s=r.name;i.onload=function(e){typeof console!="undefined"&&console.log("onload",new Date,p,d);var n=e.target.result;if(d)T(n,A);else{var r;if(p)r=XLSX.read(n,{type:"binary"});else{var i=b(n);r=XLSX.read(btoa(i),{type:"base64"})}A(r),t.$apply()}},p?i.readAsBinaryString(r):i.readAsArrayBuffer(r),t.step="ProcessFile",L("Bestand verwerken","file"),t.$apply()}}function y(e){e.stopPropagation(),e.preventDefault(),e.dataTransfer.dropEffect="copy"}function b(e){var t="",n=0,r=10240;for(;n<e.byteLength/r;++n)t+=String.fromCharCode.apply(null,new Uint8Array(e.slice(n*r,n*r+r)));return t+=String.fromCharCode.apply(null,new Uint8Array(e.slice(n*r))),t}function w(e){var t="",n=0,r=10240;for(;n<e.byteLength/r;++n)t+=String.fromCharCode.apply(null,new Uint16Array(e.slice(n*r,n*r+r)));return t+=String.fromCharCode.apply(null,new Uint16Array(e.slice(n*r))),t}function E(e){var t=new ArrayBuffer(e.length*2),n=new Uint16Array(t);for(var r=0;r!=e.length;++r)n[r]=e.charCodeAt(r);return[n,t]}function S(e,t){var n=new Worker("./xlsxworker.js");n.onmessage=function(e){switch(e.data.t){case"ready":break;case"e":console.error(e.data.d);break;case"xlsx":t(JSON.parse(e.data.d))}};var r=p?e:btoa(b(e));n.postMessage({d:r,b:p})}function x(e,t){var n=new Worker(p?"./xlsxworker2.js":"./xlsxworker1.js");n.onmessage=function(e){var n;switch(e.data.t){case"ready":break;case"e":console.error(e.data.d);break;default:n=w(e.data).replace(/\n/g,"\\n").replace(/\r/g,"\\r"),console.log("done"),t(JSON.parse(n))}};if(p){var r=E(e);n.postMessage(r[1],[r[1]])}else n.postMessage(e,[e])}function T(e,t){v=document.getElementsByName("xferable")[0].checked,v?x(e,t):S(e,t)}function N(e){var t=document.getElementsByName(e);for(var n=0;n<t.length;n++)if(t[n].checked||t.length===1)return t[n].value}function k(){typeof console!="undefined"&&console.log("onload",new Date);var e=XLSX.read(C.value,{type:"base64",WTF:m});A(e)}function L(e,t){var n=$("#breadcrumb"),r="#/upload";t&&(r="#/upload#"+t);var i=n.contents().last().wrap('<a href="'+r+'">');n.append(e)}function A(e){L("Week kiezen","chooseWeek"),t.step="SelectSheet",t.sheetNames=Object.keys(e.Sheets),t.workbook=e}function O(e){var t=[];for(var n in e){var r=e[n];r.originalName=n,t.push(r)}return t.sort(function(e,t){return e.score-t.score}),t}function M(e){try{var t=null,n}catch(r){console.log(r),console.log(r.stack)}}function _(e){try{if(e.t=="n"&&typeof e.v=="number"&&typeof e.w=="string"&&e.v>0&&e.v<2958465){var n=XLSX.SSF.parse_date_code(e.v,{date1904:t.workbook.Workbook.WBProps.date1904=="1"},!1);return new Date(n.y,n.m-1,n.d)}return null}catch(r){return console.log("getDateFromCell(): Cell ("+typeof e+") is "+e),null}}function D(e,t){var n=XLSX.utils.encode_cell({c:e,r:t});return n}function P(e,t,n){var r=D(t,n),i=e[r];return i}function H(e){var t=null;return e.v?t=e.v.trim():console.log("Trying to read wrong value"),t}function B(e,t){var n=/([0-9]{1,2})[^0-9]{1}([0-9]{1,2})/,r=e.v.match(n);if(r===null)return null;var i=r[1],s=r[2],o=new Date(t);return o.setHours(i),o.setMinutes(s),o}function j(e){var t=null;return typeof e!="undefined"&&(e.t==="s"||e.t==="str")&&(t=e.v.trim()),t}function F(e){function r(){return JSON.parse(localStorage["teams.own"]).value[0].uuid}function i(e){for(var t=0;t<this.maxRange.e.c;t++){var n=P(e,t,this.periodHeaderRow);if(typeof n=="undefined")continue;var r=_(n);r!==null&&(t<3&&(this.periodHeaderRows=this.findPeriodHeaders(e,t,this.periodHeaderRow+1)),this.days.push({col:t,startDate:r,routes:[]}))}console.log(this.periodHeaderRows);for(var i=0;i<this.days.length;i++){var s=this.days[i],t=s.col;for(var o in this.periodHeaderRows){var u=parseInt(o)+1;console.log("Reading next route starting at "+D(t,u));var a={startDate:s.startDate,teamMemberName:null,tasks:[],name:this.periodHeaderRows[o],doInsert:!1};for(var f=u;f<this.maxRange.e.r;f++){if(typeof this.periodHeaderRows[f]!="undefined")break;if(a.teamMemberName===null&&f===u)for(var l=-1;l<=1;l++){var c=parseInt(t)+l,n=P(e,c,f),h=j(n);h!==null&&h.length>0&&(a.teamMemberName=h)}else{var p={backendTask:{uuid:"",status:2,plannedStartVisitTime:null,plannedEndVisitTime:null,assignedTeamUuid:this.myTeamUuid,description:"Geimporteerd vanuit een spreadsheet"},clientName:null,duration:0,route:a,doInsert:!1,uploadStatus:"open"};for(var l=-1;l<=1;l++){var c=parseInt(t)+l,d=D(c,f),n=e[d];if(typeof n=="undefined")break;switch(n.t){case"b":l==-1?this.errors.push({code:1001,text:"Er is een ja/nee waarde gevonden in cell "+d+", terwijl er een tijdstip werd verwacht."}):l==0?this.errors.push({code:1002,text:"Er is een ja/nee waarde gevonden in cell "+d+", terwijl er een clientnaam werd verwacht."}):l==1&&this.errors.push({code:1003,text:"Er is een ja/nee waarde gevonden in cell "+d+", terwijl er een aantal minuten werd verwacht."});break;case"n":l==-1?this.errors.push({code:1004,text:"Er is een getal gevonden in cell "+d+", terwijl er een tijdstip werd verwacht."}):l==0?this.errors.push({code:1005,text:"Er is een getal gevonden in cell "+d+", terwijl er een clientnaam werd verwacht."}):l==1&&(p.duration=parseInt(n.v));break;case"e":this.errors.push({code:1006,text:"Er is een fout gevonden in cell "+d+": "+n.v});break;case"s":case"str":if(l==-1){var v=B(n,a.startDate);v===null?(this.errors.push({code:1007,text:"Het is niet mogelijk om het tijdstip in cell "+d+" te lezen."}),p=null):p.backendTask.plannedStartVisitTime=v}else l==0?p.clientName=j(n):l==1&&(p.duration=parseInt(n.v))}if(p===null)break}var m=p.backendTask;p!==null&&m.plannedStartVisitTime!==null&&p.clientName!==null&&(p.duration>0&&(p.doInsert=!0),a.tasks.push(p))}}a.tasks.length>0&&(a.teamMemberName===null?this.nofUnassignedRoutes++:a.doInsert=!0),this.routes.push(a),s.routes.push(a)}}this.nofUnassignedRoutes>0&&this.errors.push({code:1009,text:"Er zijn "+this.nofUnassignedRoutes+" routes waaraan nog geen teamlid is toegekend."})}function s(e,t,n){var r={},i=null;for(var s=n;s<this.maxRange.e.r;s++)for(var o=-1;o<=1;o++)try{var u=t+o,a=P(e,u,s);if(typeof a=="undefined")continue;var f=j(a);if(f===null||f.length==0)continue;f=f.toLowerCase();if(f.indexOf("fbpz")>=0)break;if(this.dayparts.indexOf(f)>=0){console.log("Found a daypart: "+f),i=f;var l=!1,c=P(e,u,s+1);if(c){var h=j(c);h!==null&&(h=h.toLowerCase(),h.indexOf("route")>=0&&(l=!0))}if(l===!1){var p=i;r[s]=p}break}if(f.indexOf("route")==0){if(i===null)throw"Found a route without having a daypart.";var p=i+" "+f;r[s]=p;break}}catch(d){return this.errors.push({code:1008,text:"Er is een onbekende fout opgetreden: "+d}),console.log(d),console.log(d.stack),r}return r}if(e==null||e["!ref"]==null)return"";this.myTeamUuid=r(),this.myTeamClientGroupId=JSON.parse(localStorage["app.teamGroup_"+this.myTeamUuid]).value[0].id,this.nofColumnsPerPeriod=3,this.firstPeriodColumn=0,this.periodHeaderRow=1,this.minimalMatchScore=.1,this.maxRange=XLSX.utils.decode_range(e["!ref"]),this.dayparts=["ochtend","namiddag","avond","middag","nacht"],this.periodHeaderRows={},this.days=[],this.teamMemberNames=[],this.routes=[],this.errors=[],this.matchedTeamMemberForName={},this.matchedClientForName={},this.nofUnassignedRoutes=0,this.nofMatches=0,this.confirmedTeamMemberForName={},this.confirmedClientForName={},this.uploadTasks=function(){var e=[];for(var t=0;t<this.routes.length;t++){var r=this.routes[t];if(!r.doInsert)continue;var i=r.teamMemberName;if(i){r.teamMember=this.matchedTeamMemberForName[i].person;var s=r.teamMember.uuid;for(var o=0;o<r.tasks.length;o++){var u=r.tasks[o];if(!u.doInsert)continue;var a=u.clientName;u.client=this.matchedClientForName[a].person;var f=u.client.uuid,l=u.backendTask;l.plannedStartVisitTime=l.plannedStartVisitTime.getTime(),l.plannedEndVisitTime=l.plannedStartVisitTime+u.duration*60*1e3,u.duration>0&&(l.plannedEndVisitTime-=1e3),l.relatedClientUuid=f,l.assignedTeamMemberUuid=s,e.push(u)}}}var h=e.map(function(e){return c._("taskAdd",null,e.backendTask).then(function(t){t.error?(console.log("error for "+e.clientName),e.uploadStatus="failed"):(console.log("success for "+e.clientName),e.uploadStatus="success")})});return n.all(h)},this.addConfirmedClient=function(e,t){this.confirmedClientForName[e]=t},this.addConfirmedTeamMember=function(e,t){this.confirmedTeamMemberForName[e]=t},this.matchClients=function(){var t=JSON.parse(localStorage["app."+this.myTeamClientGroupId]).value;angular.forEach(t,function(e){e.fullName="",e.firstName&&(e.fullName+=e.firstName),e.firstName&&e.lastName&&(e.fullName+=" "),e.lastName&&(e.fullName+=e.lastName)});for(var n=0;n<this.routes.length;n++){var r=this.routes[n];if(r.doInsert===!1)continue;for(var i=0;i<r.tasks.length;i++){var s=r.tasks[i];if(!s.doInsert)continue;var o=s.clientName;if(typeof this.matchedClientForName[o]=="undefined"){var u=[],a=null,f=o.toLowerCase();for(var l in t){var c=t[l],h=c.lastName.toLowerCase(),p=clj_fuzzy.metrics.jaro_winkler(h,f);console.log("Score for "+f+" vs. "+h+": "+p);if(p>this.minimalMatchScore){var d={score:p,person:c,task:s,matchId:this.nofMatches++};if(a==null||p>a.score)a=d;u.push(d)}}a!==null&&(u.sort(function(e,t){return t.score-e.score}),a.alternatives=u,this.matchedClientForName[o]=a)}}}},this.matchTeamMembers=function(){var t=r(),n=JSON.parse(localStorage["app."+t]).value;angular.forEach(n,function(e){e.fullName="",e.firstName&&(e.fullName+=e.firstName),e.firstName&&e.lastName&&(e.fullName+=" "),e.lastName&&(e.fullName+=e.lastName)});for(var i=0;i<this.routes.length;i++){var s=this.routes[i];if(s.doInsert===!1)continue;var o=s.teamMemberName;if(o==null)continue;if(typeof this.matchedTeamMemberForName[o]=="undefined"){var u=[],a=null,f=o.toLowerCase();for(var l in n){var c=n[l],h=c.firstName.toLowerCase(),p=clj_fuzzy.metrics.jaro_winkler(h,f);console.log("Score for "+o+" vs. "+h+": "+p);if(p>this.minimalMatchScore){var d={score:p,person:c,route:s,matchId:this.nofMatches++};if(a==null||p>a.score)a=d;u.push(d)}}a!==null&&(u.sort(function(e,t){return t.score-e.score}),a.alternatives=u,this.matchedTeamMemberForName[o]=a)}}},this.parseSheet=i,t.toggleRouteInsert=function(){for(var e=0;e<this.route.tasks.length;e++)this.route.tasks[e].doInsert=this.route.doInsert},this.findPeriodHeaders=s,this.parseSheet(e)}t.step="SelectFile",t.workbook={},t.tuSheet={},t.matchedTeamMembersByName={},t.matchedClientsByName={},t.taskCreateErrors=[],t.handleFile=function(e){g(e)},t.handleDragover=function(e){e.stopPropagation(),e.preventDefault(),e.dataTransfer.dropEffect="copy"},t.handleDragenter=function(e){e.stopPropagation(),e.preventDefault(),e.dataTransfer.dropEffect="copy"},t.handleDrop=function(e){e.stopPropagation(),e.preventDefault();var t=e.dataTransfer.files;g(t)};var p=typeof FileReader!="undefined"&&typeof FileReader.prototype!="undefined"&&typeof FileReader.prototype.readAsBinaryString!="undefined";p||(document.getElementsByName("userabs")[0].disabled=!0,document.getElementsByName("userabs")[0].checked=!1);var d=typeof Worker!="undefined";d||(document.getElementsByName("useworker")[0].disabled=!0,document.getElementsByName("useworker")[0].checked=!1);var v=d;v||(document.getElementsByName("xferable")[0].disabled=!0,document.getElementsByName("xferable")[0].checked=!1);var m=!1,C=document.getElementById("b64data");t.selectSheet=function(e){function r(){var r=n.defer();return setTimeout(function(){console.log("Start analysing sheet data"),t.tuSheet=new F(t.workbook.Sheets[e]),r.resolve()},100),r.promise}t.step="ProcessSheet",L("Sheet verwerken","processSheet"),n.when(r()).then(function(){t.uploadStepCheckStructure()})},t.uploadStepCheckStructure=function(){t.step="CheckStructure",L("Routes controleren","checkRoutes")},t.uploadStepCheckNames=function(){t.step="CheckNames",L("Namen controleren","checkNames"),t.tuSheet.matchTeamMembers(),t.tuSheet.matchClients(),t.matchedTeamMembersByName=O(t.tuSheet.matchedTeamMemberForName),t.matchedClientsByName=O(t.tuSheet.matchedClientForName)},t.textForTaskUploadStatus=function(e){var t={failed:"mislukt",open:"open",busy:"bezig",success:"gelukt"};return t[e]},t.uploadStepConfirmNames=function(){t.step="CreateTasks",L("Taken aanmaken","createTasks"),t.tuSheet.uploadTasks()}}])});